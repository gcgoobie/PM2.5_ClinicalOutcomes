---
title: "Monthly Satellite OM Analysis with CARE-PF Data - Revision 1 Final Analysis"
author: "Gillian Goobie"
date: "08/02/2022"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE, echo=F}
library(tidyverse)
library(readxl)
library(here)
library(writexl)
library(knitr)
library(lintr)
library(tidync)
library(maps)
library(ncmeta)
library(devtools)
library(RNetCDF)
library(ncdf4)
library(survival)
library(survminer)
library(lubridate)
library(cmprsk)
library(riskRegression)
library(prodlim)
library(RColorBrewer)
library(prodlim)
library(lme4)
library(performance)
library(psycho)
library(report)
library(rms)
library(splines)
library(Greg)
library(rstpm2)
library(pspline)
library(smoothHR)
library(raster)
```

# Importing Datasets
Here I am importing the file which contains monthly OM level estimates by satellite at nearest lon/lat to CAREPF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("MonthlyOMData/CARE_fILD_2000_2017_OM_2021_11_05.xlsx")
OM <- read_excel(outfile1)
```

Here I am importing the file which I used for my CIMD work that contains the baseline clinical and demographic data for 3389 patients who have CIMD and full records otherwise
```{r}
outfile2 <- here("MonthlyOMData/CAREPF_fILDPts_BaselineData_2021_10_22.xlsx")
CARE <- read_excel(outfile2)
```

# Merging Datasets
I used a inner_join here so that the complete "OM" dataframe only includes patients with fILD that have all baseline demographics and CIMD available as well as OM data.
```{r}
OM <- inner_join(CARE, OM, by="ID")
```

# Extracting year of diagnosis and year of death/transplant/censoring
Since the OM Satellite data is only averages by month, I want to create a column for each patient where just the month/year of diagnosis and the month/year of death or lung transplant is extracted. Then I can use this to determine the average OM exposure in the 5yrs prior to diagnosis and in the years from diagnosis until death/tx.
```{r}
#Start with the year of diagnosis
OM <- OM %>% 
  mutate(dx_yrmo = format(as.Date(OM$dx_date, format="%Y-%m-%d"),"%Y-%m"))
OM <- OM %>% 
  mutate(dx_yr = format(as.Date(OM$dx_date, format="%Y-%m-%d"),"%Y"))
OM$dx_yr <- as.numeric(OM$dx_yr)

#Then the year of death or lung transplant
OM <- OM %>% 
  mutate(deathORtx_date = if_else(!is.na(tx_date), tx_date, death_date))
OM <- OM %>% 
  mutate(deathORtx_yrmo = format(as.Date(OM$deathORtx_date, format="%Y-%m-%d"),"%Y-%m"))

#Then the year the records were last updated (i.e. year of censoring)
OM <- OM %>% 
  mutate(DeathTxCensor_date = if_else(!is.na(deathORtx_date), deathORtx_date, last_updated))
OM <- OM %>% 
  mutate(censor_yrmo = format(as.Date(OM$DeathTxCensor_date, format="%Y-%m-%d"),"%Y-%m"))
```

# Pivoting to Long Format
First we need to convert the OM dataframe into the long rather than the wide format, which will allow us to use it more easily in R's tidyverse as this is "tidy" formatting.
```{r}
OM <- OM %>% 
  pivot_longer(cols=c(66:280), names_to="OM_date", names_prefix="OM_")
```

## Convert date OM_date to same format as above
```{r}
OMx <- OM 
OMx$OM_date <- gsub("jan", "01-01-20", OMx$OM_date)
OMx$OM_date <- gsub("feb", "01-02-20", OMx$OM_date)
OMx$OM_date <- gsub("mar", "01-03-20", OMx$OM_date)
OMx$OM_date <- gsub("apr", "01-04-20", OMx$OM_date)
OMx$OM_date <- gsub("may", "01-05-20", OMx$OM_date)
OMx$OM_date <- gsub("jun", "01-06-20", OMx$OM_date)
OMx$OM_date <- gsub("jul", "01-07-20", OMx$OM_date)
OMx$OM_date <- gsub("aug", "01-08-20", OMx$OM_date)
OMx$OM_date <- gsub("sep", "01-09-20", OMx$OM_date)
OMx$OM_date <- gsub("oct", "01-10-20", OMx$OM_date)
OMx$OM_date <- gsub("nov", "01-11-20", OMx$OM_date)
OMx$OM_date <- gsub("dec", "01-12-20", OMx$OM_date)

OMx$OM_date <- format(as.Date(OMx$OM_date, format="%d-%m-%Y"),"%Y-%m-%d")
OMx$OM_date <- as.Date(OMx$OM_date)
OM <- OMx
```


# Convert Date Columns to Date Format
Next I need to convert all date columns to proper format
```{r}
OM <- OM %>% 
  mutate_at(c("dob", "dx_date", "initial_visit_date", "formal_dx_date", "reg_update", "death_date", "tx_date", "pft_date", "last_updated", "deathORtx_date", "DeathTxCensor_date"), as.Date)
str(OM)
```

# Creating Exposure Variables
Now I'm creating new variables where I am matching up OM averages per year to years of major events for patients (year of diagnosis, year of death/lung transplant/censoring, etc)
## 5yrs Pre-Death/Transplant/Censoring
Here I am calculating the average OM value in the 5yrs prior to death/lung transplant/censoring.
```{r}
OM <- OM %>% 
  group_by(ID) %>% 
  mutate(OM_5yrPreCensor = mean(value[ymd(OM_date)>=(ymd(DeathTxCensor_date) - years(5)) & 
                                        ymd(OM_date)<=ymd(DeathTxCensor_date)]))
           
           
#mean(value[ymd(OM_date) == ymd(DeathTxCensor_date) | ymd(OM_date) == (ymd(DeathTxCensor_date) - years(1))]))
```

## 5 years Prior to Diagnosis
Here I am calculating the average OM value in the year of diagnosis and the 5 years leading up to diagnosis (so if all years available, it will be the average of 6 years).
```{r}
OM <- OM %>% 
  group_by(ID) %>% 
  mutate(OM_5yrPreDx = mean(value[ymd(OM_date) <= ymd(dx_date) & 
                                    ymd(OM_date) >= (ymd(dx_date)-years(5))]))
```

## Remove Dataframes not in use
```{r}
rm(list=c("OMx", "CARE"))
```

## Getting Rid of Duplicated IDs
Now that we have calculated the patient-specific OM exposures, I can get rid of all rows other than the first row for each patient.
```{r}
OM <-  OM %>% 
  distinct_at(vars(ID), .keep_all=T)
```
This takes us down to our  observations that we had before.

# Creating High vs Low Exposure Groups
Cutoffs are based on calculations performed where the median total OM mass across all three cohorts was averaged, then the median constituent component proportion of total OM across all three cohorts was averaged. Subsequently, the average proportion of each constituent across the three cohorts was multiplied by the average of the total OM mass medians across the three cohorts to get the approximate median total mass of each constituent across all three cohorts, which was used to define the low vs high exposure cut points.

## OM 5yrs Pre-Censor High vs Low
```{r}
OM$OM5yrCensor_dich <- cut(OM$OM_5yrPreCensor,
                      breaks=c(0, 2.88, 50),
                      labels=c("Low", "High"))
summary(OM$OM5yrCensor_dich)
class(OM$OM5yrCensor_dich)
```

## OM 5yrs Pre-Diagnosis High vs Low
```{r}
OM$OM5yr_dich <- cut(OM$OM_5yrPreDx,
                      breaks=c(0, 2.95, 50),
                      labels=c("Low", "High"))
summary(OM$OM5yr_dich)
class(OM$OM5yr_dich)
```


# Creating Other New Variables
## IPF vs Other Diagnosis
```{r}
OM <- OM %>% 
  mutate(dx_IPF=ifelse(dx=="IPF", "IPF", "not_IPF"))    
```

## Changing site to a factor variable
```{r}
OM$site <- as.factor(OM$site)
```

# Releveling Factors
Here I am releveling factors so that they are in an intuitive order for my later analyses.
```{r}
OM$sex <- fct_relevel(OM$sex, c("M","F"))
OM$race <- fct_relevel(OM$race, c("W","B","A","N","U"))
OM$ethnicity <- fct_relevel(OM$ethnicity, c("N","H","D","U"))
OM$dich_Race <- fct_relevel(OM$dich_Race, c("White","Non-White"))
OM$smokeHx <- fct_relevel(OM$smokeHx, c("Never","Former","Always"))

#For dx and dx_group, I just want IPF to be first and then the rest of the categories are alphabetical
OM$dx <- fct_relevel(OM$dx, c("IPF"))
OM$dx_group <- fct_relevel(OM$dx_group, c("IPF"))
OM$dx_IPF <- fct_relevel(OM$dx_IPF, c("IPF"))
str(OM)
```

# Creating Datasets with only Metropolitan Patients
```{r}
OM_metro <- OM %>% filter(metro=="metropolitan")
```
This results in a dataset of  patients

# Creating Datasets with only IPF Patients
```{r}
OM_IPF <- OM %>% filter(dx=="IPF")
```
This results in a dataset of  pts

# Creating Datasets with only CTD Patients
```{r}
OM_CTD <- OM %>% filter(dx_group=="CTD-ILD")
```
This results in a dataset of  pts

# Creating individual site subgroups
```{r}
OM_toronto <- OM %>% filter(site==101)
OM_ab <- OM %>% filter(site==102)
OM_sph <- OM %>% filter(site==103)
OM_vgh <- OM %>%  filter(site==104)
OM_bc <- OM %>% filter(site==103 | site==104)
OM_laval <- OM %>% filter(site==105)
OM_hamilton <- OM %>% filter(site==106)
OM_on <- OM %>% filter(site==101 | site==106)
OM_mcgill <- OM %>% filter(site==107)
OM_qc <- OM %>% filter(site==105 | site==107)
OM_sk <- OM %>% filter(site==108)
```


# Export Excel File with OM Data Matched to Patients and Full Cohort Data
```{r}
write_xlsx(OM, path="Final_CAREPF_fILD_OM_BaselineData_2022_02_12.xlsx")
```

# Exploratory Data Analysis
This is a function that allows me to make tables which summarize the count and percentages of each level of factor variables
```{r}
n_prop_tbl <- function(x) {
  tbl <- table(x)
  res <- cbind(tbl, round(prop.table(tbl)*100,2))
  colnames(res) <-  c('Count', 'Percentage')
  res
}
```


## OM Breakdown
```{r}
summary(OM$OM_5yrPreCensor)
summary(OM$OM_5yrPreDx)
```


## Sex Breakdown
```{r}
n_prop_tbl(OM$sex)
```

## Race and Ethnicity Breakdown 
```{r}
n_prop_tbl(OM$race)

n_prop_tbl(OM$ethnicity)
```

## Smoking History Breakdown
```{r}
n_prop_tbl(OM$smokeHx)
summary(OM$pkyrs)
```


## Diagnostic Group Breakdown
```{r}
n_prop_tbl(OM$dx_group)
```


## Province and Site Breakdown
```{r}
n_prop_tbl(OM$province)
n_prop_tbl(OM$site)
```

### Metropolitan Breakdown
```{r}
n_prop_tbl(OM$metro)
```
69% are metropolitan

## Age at Diagnosis Breakdown
```{r}
shapiro.test(OM$age_dx)
#Shapiro tests tells us that age_dx is not normally distributed, so should report median, IQR
summary(OM$age_dx)
```

## CIMD Breakdown
```{r}
summary(OM$avg_s)
```


## Vital Status Breakdown
```{r}
n_prop_tbl(OM$status)
```
Majority of the patients in CARE-PF are still alive.

## Baseline Lung Function Breakdown
```{r}
shapiro.test(OM$fvc_pct)
summary(OM$fvc_pct)
sd(OM$fvc_pct, na.rm=T)
```

```{r}
shapiro.test(OM$dlco_pct)
summary(OM$dlco_pct)
sd(OM$dlco_pct, na.rm=T)
```

## Time to Censoring Breakdown
```{r}
summary(OM$time_DeathTxCensor)
sd(OM$time_DeathTxCensor, na.rm=T)
```


## Breakdown of Characteristics by Low vs High
### OM_5yrPreCensor Low vs High
```{r}
table(OM$sex, OM$OM5yrCensor_dich)
table(OM$race, OM$OM5yrCensor_dich)
table(OM$dich_Race, OM$OM5yrCensor_dich)
table(OM$dx_group, OM$OM5yrCensor_dich)
table(OM$smokeHx, OM$OM5yrCensor_dich)
table(OM$metro, OM$OM5yrCensor_dich)
table(OM$province, OM$OM5yrCensor_dich)
table(OM$status, OM$OM5yrCensor_dich)
group_by(OM, OM5yrCensor_dich) %>%
  summarise(
    count = n(),
    mean = mean(age_dx, na.rm = TRUE),
    sd = sd(age_dx, na.rm = TRUE),
    median = median(age_dx, na.rm = TRUE),
    quantile = quantile(age_dx, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(age_dx, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yrCensor_dich) %>%
  summarise(
    count = n(),
    mean = mean(avg_s, na.rm = TRUE),
    sd = sd(avg_s, na.rm = TRUE),
    median = median(avg_s, na.rm = TRUE),
    quantile = quantile(avg_s, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(avg_s, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yrCensor_dich) %>%
  summarise(
    count = n(),
    mean = mean(fvc_pct, na.rm = TRUE),
    sd = sd(fvc_pct, na.rm = TRUE),
    median = median(fvc_pct, na.rm = TRUE),
    quantile = quantile(fvc_pct, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(fvc_pct, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yrCensor_dich) %>%
  summarise(
    count = n(),
    mean = mean(dlco_pct, na.rm = TRUE),
    sd = sd(dlco_pct, na.rm = TRUE),
    median = median(dlco_pct, na.rm = TRUE),
    quantile = quantile(dlco_pct, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(dlco_pct, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yrCensor_dich) %>%
  summarise(
    count = n(),
    mean = mean(time_DeathTxCensor, na.rm = TRUE),
    sd = sd(time_DeathTxCensor, na.rm = TRUE),
    median = median(time_DeathTxCensor, na.rm = TRUE),
    quantile = quantile(time_DeathTxCensor, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(time_DeathTxCensor, probs=c(0.75), na.rm = TRUE)
  )
```

### OM_5yrPreDx Low vs High
```{r}
table(OM$sex, OM$OM5yr_dich)
table(OM$race, OM$OM5yr_dich)
table(OM$dich_Race, OM$OM5yr_dich)
table(OM$dx_group, OM$OM5yr_dich)
table(OM$smokeHx, OM$OM5yr_dich)
table(OM$metro, OM$OM5yr_dich)
table(OM$province, OM$OM5yr_dich)
table(OM$status, OM$OM5yr_dich)
group_by(OM, OM5yr_dich) %>%
  summarise(
    count = n(),
    mean = mean(age_dx, na.rm = TRUE),
    sd = sd(age_dx, na.rm = TRUE),
    median = median(age_dx, na.rm = TRUE),
    quantile = quantile(age_dx, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(age_dx, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yr_dich) %>%
  summarise(
    count = n(),
    mean = mean(avg_s, na.rm = TRUE),
    sd = sd(avg_s, na.rm = TRUE),
    median = median(avg_s, na.rm = TRUE),
    quantile = quantile(avg_s, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(avg_s, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yr_dich) %>%
  summarise(
    count = n(),
    mean = mean(fvc_pct, na.rm = TRUE),
    sd = sd(fvc_pct, na.rm = TRUE),
    median = median(fvc_pct, na.rm = TRUE),
    quantile = quantile(fvc_pct, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(fvc_pct, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yr_dich) %>%
  summarise(
    count = n(),
    mean = mean(dlco_pct, na.rm = TRUE),
    sd = sd(dlco_pct, na.rm = TRUE),
    median = median(dlco_pct, na.rm = TRUE),
    quantile = quantile(dlco_pct, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(dlco_pct, probs=c(0.75), na.rm = TRUE)
  )
group_by(OM, OM5yr_dich) %>%
  summarise(
    count = n(),
    mean = mean(time_DeathTxCensor, na.rm = TRUE),
    sd = sd(time_DeathTxCensor, na.rm = TRUE),
    median = median(time_DeathTxCensor, na.rm = TRUE),
    quantile = quantile(time_DeathTxCensor, probs=c(0.25), na.rm = TRUE),
    quantile2 = quantile(time_DeathTxCensor, probs=c(0.75), na.rm = TRUE)
  )
```


## Visual EDA
### Histograms
Histogram of OM Exposure 5yr Pre-Death/Transplant/Censoring
```{r}
(OM %>% ggplot(aes(x=OM_5yrPreCensor))+
   geom_histogram(fill="blue", color="black")+
   labs(x="Average OM Level 5yr Prior to Death/Transplant/Censoring", y="Number of patients with fILD", title="Average OM 5yr Prior to Death/Transplant/Censoring")+
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(0,20))
```


Histogram of OM Exposure 5yr Pre-Dx
```{r}
(OM %>% ggplot(aes(x=OM_5yrPreDx))+
   geom_histogram(fill="blue", color="black")+
   labs(x="Average OM Level 5yr Prior to Diagnosis", y="Number of patients with fILD", title="Average OM 5yr Prior to Diagnosis")+
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(0,20))
```


### Violin plots of OM vs other demographic variables
Violin plot wrapping boxplot to visualize low vs high OM5yrCensor_dich vs CIMD
```{r}
(OM %>% ggplot(aes(x=OM5yrCensor_dich, y=avg_s, fill=OM5yrCensor_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Low vs High OM in 5yrs Pre-Censoring", y="National CIMD", title="National CIMD by OM Exposure")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(-2.5,2.5))
```

Violin plot wrapping boxplot to visualize sex vs OM_5yrPreCensor
```{r}
(OM %>% ggplot(aes(x=sex, y=OM_5yrPreCensor, fill=sex))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Sex", y="Average OM 5 Years Pre-Censor", title="OM Exposure Pre-Censor by Sex")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```


Violin plot wrapping boxplot to visualize sex vs OM_5yrPreDx
```{r}
(OM %>% ggplot(aes(x=sex, y=OM_5yrPreDx, fill=sex))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Sex", y="Average OM 5 Years Pre-Diagnosis", title="OM Exposure Pre-Diagnosis by Sex")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```

Violin plot wrapping boxplot to visualize dich_Race vs OM_5yrPreCensor
```{r}
(OM %>% ggplot(aes(x=dich_Race, y=OM_5yrPreCensor, fill=dich_Race))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Race", y="Average OM 5 Years Pre-Censoring", title="OM Exposure Pre-Censoring by Race")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```


Violin plot wrapping boxplot to visualize race vs OM_5yrPreCensor
```{r}
(OM %>% ggplot(aes(x=race, y=OM_5yrPreCensor, fill=race))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Race", y="Average OM 5 Years Pre-Censoring", title="OM Exposure Pre-Censoring by Race")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```

Violin plot wrapping boxplot to visualize dich_Race vs OM_5yrPreDx
```{r}
(OM %>% ggplot(aes(x=dich_Race, y=OM_5yrPreDx, fill=dich_Race))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Race", y="Average OM 5 Years Pre-Diagnosis", title="OM Exposure Pre-Diagnosis by Race")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```

Violin plot wrapping boxplot to visualize race vs OM_5yrPreDx
```{r}
(OM %>% ggplot(aes(x=race, y=OM_5yrPreDx, fill=race))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Race", y="Average OM 5 Years Pre-Diagnosis", title="OM Exposure Pre-Diagnosis by Race")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```

Violin plot wrapping boxplot to visualize metro vs OM_5yrPreCensor
```{r}
(OM %>% ggplot(aes(x=metro, y=OM_5yrPreCensor, fill=metro))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Residential Location", y="Average OM in 5yrs Pre-Censoring", title="OM Exposure in 5yrs Pre-Censoring by Residential Location")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```


Violin plot wrapping boxplot to visualize metro vs OM_5yrPreDx
```{r}
(OM %>% ggplot(aes(x=metro, y=OM_5yrPreDx, fill=metro))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="Residential Location", y="Average OM in 5yrs Pre-Diagnosis", title="OM Exposure in 5yrs Pre-Diagnosis by Residential Location")+
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```

### Scatterplots of OM over time
Scatterplot showing average OM 5yr pre-death/transplant/censoring
```{r}
(OM %>% ggplot(aes(x=dx_date, y=OM_5yrPreCensor))+
   geom_point()+
   labs(x="Date of Diagnosis", y="OM Exposure 5yr Prior Death/Transplant/Censoring", title="OM 5yr Prior to Death/Transplant/Censoring vs Date of Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```


```{r}
(OM %>% ggplot(aes(x=dx_date, y=OM_5yrPreCensor, color=site))+
   geom_point(alpha=0.5)+
   labs(x="Date of Diagnosis", y="OM Exposure 5yr Prior Death/Transplant/Censoring", title="OM 5yr Prior to Death/Transplant/Censoring vs Date of Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20))
```

Scatterplot showing average OM during 5yrs pre-diagnosis level by year of diagnosis
```{r}
(OM %>% ggplot(aes(x=dx_date, y=OM_5yrPreDx))+
   geom_point()+
   labs(x="Date of Diagnosis", y="OM Exposure During 5yrs Pre-Diagnosis", title="Pre-Diagnosis OM vs Date of Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20)+
   scale_x_date(limits = as.Date(c("2000-01-01","2020-01-01"))))
```


Scatterplot showing average OM during 5yrs pre-diagnosis level by year of diagnosis
```{r}
(OM %>% ggplot(aes(x=dx_date, y=OM_5yrPreDx, color=site))+
   geom_point(alpha=0.5)+
   labs(x="Date of Diagnosis", y="OM Exposure During 5yrs Pre-Diagnosis", title="Pre-Diagnosis OM vs Date of Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   ylim(0,20)+
   scale_x_date(limits = as.Date(c("2000-01-01","2020-01-01"))))
```


# Cox PH Models for Association between OM and Death or Lung Transplant
## OM 5yrs Pre-Censoring Models
### Continuous OM 5yrs pre-censoring until Death/Transplant/Censoring
Start with the simplest model just looking at OM in the year of and 5yrs prior to death/transplant/censoring
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor, data=OM, id=ID)
summary(coxPH_model1)
```


Complete model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM, id=ID)
summary(coxPH_model2)
```


Complete model + dx_yr
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM, id=ID)
summary(coxPH_model3)
```



### Smoothed HR Function for 5yr Pre-Censor Continuous
Base model
```{r}
coxPH_model1_tvc <- cox.tvc(coxPH_model1, "OM_5yrPreCensor")
print(coxPH_model1_tvc)
plot(coxPH_model1_tvc)
```


Complete model (all covariates except lung function)
```{r}
coxPH_model2_tvc <- cox.tvc(coxPH_model2, "OM_5yrPreCensor")
print(coxPH_model2_tvc)
plot(coxPH_model2_tvc)
```


```{r}
coxPH_model3_tvc <- cox.tvc(coxPH_model3, "OM_5yrPreCensor")
print(coxPH_model3_tvc)
plot(coxPH_model3_tvc)
```


### Variable HR for OM risk in 5yr Pre-Cenosr
Want a plot with x-axis of OM level and y-axis of HR

Unadjusted model
```{r}
summary(OM$OM_5yrPreCensor)
summary(OM$time_DeathTxCensor)
#First need to make dataframe that only includes patients with time_DeathTxCensor
OMx <- OM %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor))

#Then make survival function
surv1 <- Surv(OMx$time_DeathTxCensor, OMx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(OMx$OM_5yrPreCensor, df=3))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(OMx$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
OMx <- OM %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(avg_s) & !is.na(site))

#Then survival function
surv1 <- Surv(OMx$time_DeathTxCensor, OMx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(OMx$OM_5yrPreCensor, df=3) + OMx$age_dx + OMx$sex + OMx$smokeHx + OMx$dich_Race + OMx$avg_s + OMx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(OMx$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model + dx_yr
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
OMx <- OM %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(avg_s) & !is.na(site) & !is.na(dx_yr))

#Then survival function
surv1 <- Surv(OMx$time_DeathTxCensor, OMx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(OMx$OM_5yrPreCensor, df=3) + OMx$age_dx + OMx$sex + OMx$smokeHx + OMx$dich_Race + OMx$avg_s + OMx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(OMx$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```


### OM Low vs High 5yrs Pre-Censoring
Base Model:
```{r}
coxPH_model7 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=OM, id=ID)
summary(coxPH_model7)
```

Complete model
```{r}
coxPH_model8 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM, id=ID)
summary(coxPH_model8)
```

Complete model + dx_yr
```{r}
coxPH_model9 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM, id=ID)
summary(coxPH_model9)
```


Now I will make a Kaplan-Meier survival curve, discretized by OM during disease deciles:
```{r, fig.height=5, fig.width=7}
surv1 <- survfit(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=OM)
(ggsurvplot(surv1, 
            palette=c("dodgerblue4","firebrick4"),
            censor=TRUE,
            pval=TRUE,
            xlim=c(0,10),
            legend="right",
           data=OM,
           legend.title="OM Exposure",
           legend.labs=c("Low", "High"),
           risk.table=T,
           title="Time to Death or Transplant by OM 5yrs Pre-Censoring",
           xlab="Time (years)",
           ylab="Survival Probability (Death or Lung Transplant)",
           ggtheme = theme_grey()
           ))
```


Now we want to check the proportionality assumption by plotting the scaled Schoenfield residuals against time for each covariate in our final model.
```{r}
residtest <- cox.zph(coxPH_model8)
residtest
ggcoxzph(residtest)
```


Now I will present a forest plot with the model
```{r}
ggforest(coxPH_model8)
```



# Association between OM and Baseline FVC
## Visual EDA 5yrs pre-Dx
Scatterplot of continuous OM 5yrs pre-diagnosis vs FVC, with sex represented by the color of points
```{r}
(OM %>% ggplot(aes(x=OM_5yrPreDx, y=fvc_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(0,7))
```


Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs FVC
```{r}
OMb <- OM %>% filter(!is.na(OM5yr_dich))
(OMb %>% ggplot(aes(x=OM5yr_dich, y=fvc_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```



## OM 5yrs Pre-Diagnosis and FVC Models
Looking at continuous OM_5yrPreDx vs baseline FVC

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1 <- lm(fvc_pct ~ OM_5yrPreDx, data=OM)
summary(FVC_model1)
confint(FVC_model1)
```

Complete model
```{r}
FVC_model2 <- lm(fvc_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM)
summary(FVC_model2)
confint(FVC_model2)
```

Complete model + dx_yr
```{r}
FVC_model3 <- lm(fvc_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM)
summary(FVC_model3)
confint(FVC_model3)
```


### OM 5yrs Pre-Diagnosis Low vs High and Baseline FVC
Looking at OM5yr_dich vs baseline FVC

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1 <- lm(fvc_pct ~ OM5yr_dich, data=OM)
summary(FVC_model1)
confint(FVC_model1)
```

Complete model
```{r}
FVC_model2 <- lm(fvc_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM)
summary(FVC_model2)
confint(FVC_model2)
```

Complete model + dx_yr
```{r}
FVC_model3 <- lm(fvc_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM)
summary(FVC_model3)
confint(FVC_model3)
```

# Association between OM and Baseline DLCO
## Visual EDA 5yrs pre-Dx
Scatterplot of continuous OM 5yrs pre-diagnosis vs DLCO, with sex represented by the color of points
```{r}
(OM %>% ggplot(aes(x=OM_5yrPreDx, y=dlco_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(0,12))
```


Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs dlco
```{r}
(OMb %>% ggplot(aes(x=OM5yr_dich, y=dlco_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```



## OM 5yrs Pre-Diagnosis and DLCO Models
### OM 5yrs Pre-Diagnosis and Baseline DLCO
Looking at continuous OM_5yrPreDx vs baseline DLCO

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1 <- lm(dlco_pct ~ OM_5yrPreDx, data=OM)
summary(DLCO_model1)
confint(DLCO_model1)
```

Complete model
```{r}
DLCO_model2 <- lm(dlco_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM)
summary(DLCO_model2)
confint(DLCO_model2)
```

Complete model + dx_yr
```{r}
DLCO_model3 <- lm(dlco_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM)
summary(DLCO_model3)
confint(DLCO_model3)
```


### OM 5yrs Pre-Diagnosis Low vs High and Baseline DLCO
Looking at OM5yr_dich vs baseline DLCO

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1 <- lm(dlco_pct ~ OM5yr_dich, data=OM)
summary(DLCO_model1)
confint(DLCO_model1)
```

Complete model
```{r}
DLCO_model2 <- lm(dlco_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM)
summary(DLCO_model2)
confint(DLCO_model2)
```


Complete model + dx_yr
```{r}
DLCO_model3 <- lm(dlco_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM)
summary(DLCO_model3)
confint(DLCO_model3)
```


# IPF-Only - Cox PH Models for Association between OM and Death or Lung Transplant
## IPF-Only - OM 5yrs Pre-Censoring Models
### IPF-Only - Continuous OM 5yrs pre-censoring until Death/Transplant/Censoring
Start with the simplest model just looking at OM in the year of and 5yrs prior to death/transplant/censoring
```{r}
coxPH_model1 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor, data=OM_IPF, id=ID)
summary(coxPH_model1)
```


Complete model
```{r}
coxPH_model2 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM_IPF, id=ID)
summary(coxPH_model2)
```


Complete model + dx_yr
```{r}
coxPH_model3 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM_IPF, id=ID)
summary(coxPH_model3)
```



### IPF-Only - Smoothed HR Function for 5yr Pre-Censor Continuous
Base model
```{r}
coxPH_model1_tvc <- cox.tvc(coxPH_model1, "OM_5yrPreCensor")
print(coxPH_model1_tvc)
plot(coxPH_model1_tvc)
```


Complete model (all covariates except lung function)
```{r}
coxPH_model2_tvc <- cox.tvc(coxPH_model2, "OM_5yrPreCensor")
print(coxPH_model2_tvc)
plot(coxPH_model2_tvc)
```


```{r}
#coxPH_model3_tvc <- cox.tvc(coxPH_model3, "OM_5yrPreCensor")
#print(coxPH_model3_tvc)
#plot(coxPH_model3_tvc)
```
Error with the bove code "Error in optim(par = c(OM_5yrPreCensor = 4.98043221986785, sexF = -0.272936265634474, : 
initial value in 'vmmin' is not finite"

### IPF-Only - Variable HR for OM risk in 5yr Pre-Cenosr
Want a plot with x-axis of OM level and y-axis of HR

Unadjusted model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
OMx <- OM_IPF %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor))

#Then make survival function
surv1 <- Surv(OMx$time_DeathTxCensor, OMx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(OMx$OM_5yrPreCensor, df=3))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(OMx$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
OMx <- OM_IPF %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(avg_s) & !is.na(site))

#Then survival function
surv1 <- Surv(OMx$time_DeathTxCensor, OMx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(OMx$OM_5yrPreCensor, df=3) + OMx$age_dx + OMx$sex + OMx$smokeHx + OMx$dich_Race + OMx$avg_s + OMx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(OMx$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete Model + dx_yr
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
OMx <- OM_IPF %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(avg_s) & !is.na(site) & !is.na(dx_yr))

#Then survival function
surv1 <- Surv(OMx$time_DeathTxCensor, OMx$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(OMx$OM_5yrPreCensor, df=4) + OMx$age_dx + OMx$sex + OMx$smokeHx + OMx$dich_Race + OMx$avg_s + OMx$site + OMx$dx_yr)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(OMx$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(OMx$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```


### IPF-Only - OM Low vs High 5yrs Pre-Censoring
Base Model:
```{r}
coxPH_model7 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=OM_IPF, id=ID)
summary(coxPH_model7)
```


Complete model
```{r}
coxPH_model8 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM_IPF, id=ID)
summary(coxPH_model8)
```


Complete model + dx_yr
```{r}
coxPH_model9 <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM_IPF, id=ID)
summary(coxPH_model9)
```


Now I will make a Kaplan-Meier survival curve, discretized by OM during disease deciles:
```{r, fig.height=5, fig.width=7}
surv1 <- survfit(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=OM_IPF)
(ggsurvplot(surv1, 
            palette=c("dodgerblue4","firebrick4"),
            censor=TRUE,
            pval=TRUE,
            xlim=c(0,10),
            legend="right",
           data=OM_IPF,
           legend.title="OM Exposure",
           legend.labs=c("Low", "High"),
           risk.table=T,
           title="Time to Death or Transplant by OM 5yrs Pre-Censoring",
           xlab="Time (years)",
           ylab="Survival Probability (Death or Lung Transplant)",
           ggtheme = theme_grey()
           ))
```


Now we want to check the proportionality assumption by plotting the scaled Schoenfield residuals against time for each covariate in our final model.
```{r}
residtest <- cox.zph(coxPH_model9)
residtest
ggcoxzph(residtest)
```


Now I will present a forest plot with the model
```{r}
ggforest(coxPH_model9)
```



# IPF-Only - Association between OM and Baseline FVC
## IPF-Only - Visual EDA 5yrs pre-Dx
Scatterplot of continuous OM 5yrs pre-diagnosis vs FVC, with sex represented by the color of points
```{r}
(OM %>% ggplot(aes(x=OM_5yrPreDx, y=fvc_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(0,7))
```


Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs FVC
```{r}
OMb <- OM %>% filter(!is.na(OM5yr_dich))
(OMb %>% ggplot(aes(x=OM5yr_dich, y=fvc_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```



## IPF-Only - OM 5yrs Pre-Diagnosis and FVC Models
Looking at continuous OM_5yrPreDx vs baseline FVC

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1 <- lm(fvc_pct ~ OM_5yrPreDx, data=OM_IPF)
summary(FVC_model1)
confint(FVC_model1)
```

Complete model
```{r}
FVC_model2 <- lm(fvc_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM_IPF)
summary(FVC_model2)
confint(FVC_model2)
```

Complete model + dx_yr
```{r}
FVC_model3 <- lm(fvc_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM_IPF)
summary(FVC_model3)
confint(FVC_model3)
```


### IPF-Only - OM 5yrs Pre-Diagnosis Low vs High and Baseline FVC
Looking at OM5yr_dich vs baseline FVC

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1 <- lm(fvc_pct ~ OM5yr_dich, data=OM_IPF)
summary(FVC_model1)
confint(FVC_model1)
```

Complete model
```{r}
FVC_model2 <- lm(fvc_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM_IPF)
summary(FVC_model2)
confint(FVC_model2)
```

Complete model + dx_yr
```{r}
FVC_model3 <- lm(fvc_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM_IPF)
summary(FVC_model3)
confint(FVC_model3)
```

# IPF-Only - Association between OM and Baseline DLCO
## IPF-Only - Visual EDA 5yrs pre-Dx
Scatterplot of continuous OM 5yrs pre-diagnosis vs DLCO, with sex represented by the color of points
```{r}
(OM %>% ggplot(aes(x=OM_5yrPreDx, y=dlco_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(0,12))
```


Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs DLCO
```{r}
(OMb %>% ggplot(aes(x=OM5yr_dich, y=dlco_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```



## IPF-Only - OM 5yrs Pre-Diagnosis and DLCO Models
### IPF-Only - OM 5yrs Pre-Diagnosis and Baseline DLCO
Looking at continuous OM_5yrPreDx vs baseline DLCO

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1 <- lm(dlco_pct ~ OM_5yrPreDx, data=OM_IPF)
summary(DLCO_model1)
confint(DLCO_model1)
```

Complete model
```{r}
DLCO_model2 <- lm(dlco_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM_IPF)
summary(DLCO_model2)
confint(DLCO_model2)
```

Complete model + dx_yr
```{r}
DLCO_model3 <- lm(dlco_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM_IPF)
summary(DLCO_model3)
confint(DLCO_model3)
```


### IPF-Only - OM 5yrs Pre-Diagnosis Low vs High and Baseline DLCO
Looking at OM5yr_dich vs baseline DLCO

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1 <- lm(dlco_pct ~ OM5yr_dich, data=OM_IPF)
summary(DLCO_model1)
confint(DLCO_model1)
```

Complete model
```{r}
DLCO_model2 <- lm(dlco_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=OM_IPF)
summary(DLCO_model2)
confint(DLCO_model2)
```


Complete model + dx_yr
```{r}
DLCO_model3 <- lm(dlco_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site + dx_yr, data=OM_IPF)
summary(DLCO_model3)
confint(DLCO_model3)
```



# Pre-2015 vs Post-2015 Models
```{r}
pre2015 <- OM %>% filter(dx_yr<=2015)

post2015 <- OM %>% filter(dx_yr>2015)
```

# Pre/Post-2015 Only - Cox PH Models for Association between OM and Death or Lung Transplant
## Pre/Post-2015 Only - OM 5yrs Pre-Censoring Models
### Pre/Post-2015 Only - Continuous OM 5yrs pre-censoring until Death/Transplant/Censoring
Start with the simplest model just looking at OM in the year of and 5yrs prior to death/transplant/censoring
```{r}
coxPH_model1a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor, data=pre2015, id=ID)
summary(coxPH_model1a)
```

```{r}
coxPH_model1b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor, data=post2015, id=ID)
summary(coxPH_model1b)
```

Complete model
```{r}
coxPH_model2a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=pre2015, id=ID)
summary(coxPH_model2a)
```

Complete model
```{r}
coxPH_model2b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM_5yrPreCensor + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=post2015, id=ID)
summary(coxPH_model2b)
```

### Pre/Post-2015 Only - Variable HR for OM risk in 5yr Pre-Cenosr
Want a plot with x-axis of OM level and y-axis of HR

Unadjusted model - Pre-2015
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
pre2015x <- pre2015 %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor))

#Then make survival function
surv1 <- Surv(pre2015x$time_DeathTxCensor, pre2015x$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(pre2015x$OM_5yrPreCensor, df=3))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(pre2015x$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(pre2015x$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(pre2015x$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(pre2015x$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Unadjusted model - Post-2015
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
post2015x <- post2015 %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor))

#Then make survival function
surv1 <- Surv(post2015x$time_DeathTxCensor, post2015x$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(post2015x$OM_5yrPreCensor, df=3))
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(post2015x$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(post2015x$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(post2015x$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(post2015x$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model Pre-2015
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
pre2015x <- pre2015 %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(avg_s) & !is.na(site))

#Then survival function
surv1 <- Surv(pre2015x$time_DeathTxCensor, pre2015x$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(pre2015x$OM_5yrPreCensor, df=3) + pre2015x$age_dx + pre2015x$sex + pre2015x$smokeHx + pre2015x$dich_Race + pre2015x$avg_s + pre2015x$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(pre2015x$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(pre2015x$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(pre2015x$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(pre2015x$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model Post-2015
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
post2015x <- post2015 %>% filter(!is.na(OM_5yrPreCensor) & !is.na(time_DeathTxCensor) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(avg_s) & !is.na(site))

#Then survival function
surv1 <- Surv(post2015x$time_DeathTxCensor, post2015x$deadORtx==1)
fit1 <- coxph(surv1 ~ pspline(post2015x$OM_5yrPreCensor, df=3) + post2015x$age_dx + post2015x$sex + post2015x$smokeHx + post2015x$dich_Race + post2015x$avg_s + post2015x$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)

#Then plot
plot(post2015x$OM_5yrPreCensor, exp(predicted$fit), type="n", xlim=c(0,8), ylim=c(0,10))
lines(sm.spline(post2015x$OM_5yrPreCensor, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(post2015x$OM_5yrPreCensor, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(post2015x$OM_5yrPreCensor, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

### Pre/Post-2015 Only - OM Low vs High 5yrs Pre-Censoring
Base Model:
```{r}
coxPH_model7a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=pre2015, id=ID)
summary(coxPH_model7a)
```

Base Model:
```{r}
coxPH_model7b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=post2015, id=ID)
summary(coxPH_model7b)
```

Complete model
```{r}
coxPH_model8a <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=pre2015, id=ID)
summary(coxPH_model8a)
```

Complete model
```{r}
coxPH_model8b <- coxph(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=post2015, id=ID)
summary(coxPH_model8b)
```


Now I will make a Kaplan-Meier survival curve, discretized by OM during disease deciles:
```{r, fig.height=5, fig.width=7}
surv1 <- survfit(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=pre2015)
(ggsurvplot(surv1, 
            palette=c("dodgerblue4","firebrick4"),
            censor=TRUE,
            pval=TRUE,
            xlim=c(0,10),
            legend="right",
           data=OM_IPF,
           legend.title="OM Exposure",
           legend.labs=c("Low", "High"),
           risk.table=T,
           title="Time to Death or Transplant by OM 5yrs Pre-Censoring",
           xlab="Time (years)",
           ylab="Survival Probability (Death or Lung Transplant)",
           ggtheme = theme_grey()
           ))
```

Now I will make a Kaplan-Meier survival curve, discretized by OM during disease deciles:
```{r, fig.height=5, fig.width=7}
surv1 <- survfit(Surv(time_DeathTxCensor, deadORtx==1) ~ OM5yrCensor_dich, data=post2015)
(ggsurvplot(surv1, 
            palette=c("dodgerblue4","firebrick4"),
            censor=TRUE,
            pval=TRUE,
            xlim=c(0,10),
            legend="right",
           data=OM_IPF,
           legend.title="OM Exposure",
           legend.labs=c("Low", "High"),
           risk.table=T,
           title="Time to Death or Transplant by OM 5yrs Pre-Censoring",
           xlab="Time (years)",
           ylab="Survival Probability (Death or Lung Transplant)",
           ggtheme = theme_grey()
           ))
```

Now we want to check the proportionality assumption by plotting the scaled Schoenfield residuals against time for each covariate in our final model.
```{r}
residtest <- cox.zph(coxPH_model8a)
residtest
ggcoxzph(residtest)
```

```{r}
residtest <- cox.zph(coxPH_model8b)
residtest
ggcoxzph(residtest)
```


Now I will present a forest plot with the model
```{r}
ggforest(coxPH_model8a)
```

```{r}
ggforest(coxPH_model8b)
```


# Pre/Post-2015 Only - Association between OM and Baseline FVC
## Pre/Post-2015 Only - Visual EDA 5yrs pre-Dx
Scatterplot of continuous OM 5yrs pre-diagnosis vs FVC, with sex represented by the color of points - Pre-2015
```{r}
(pre2015 %>% ggplot(aes(x=OM_5yrPreDx, y=fvc_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(5,20))
```

Scatterplot of continuous OM 5yrs pre-diagnosis vs FVC, with sex represented by the color of points - Post-2015
```{r}
(post2015 %>% ggplot(aes(x=OM_5yrPreDx, y=fvc_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(5,20))
```

Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs FVC - Pre-2015
```{r}
pre2015b <- pre2015 %>% filter(!is.na(OM5yr_dich))
(pre2015b %>% ggplot(aes(x=OM5yr_dich, y=fvc_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```

Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs FVC - Post-2015
```{r}
post2015b <- post2015 %>% filter(!is.na(OM5yr_dich))
(post2015b %>% ggplot(aes(x=OM5yr_dich, y=fvc_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline FVC % Predicted", title="Baseline FVC % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```



## Pre/Post-2015 Only - OM 5yrs Pre-Diagnosis and FVC Models
Looking at continuous OM_5yrPreDx vs baseline FVC

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1a <- lm(fvc_pct ~ OM_5yrPreDx, data=pre2015)
summary(FVC_model1a)
confint(FVC_model1a)
```

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1b <- lm(fvc_pct ~ OM_5yrPreDx, data=post2015)
summary(FVC_model1b)
confint(FVC_model1b)
```

Complete model
```{r}
FVC_model2a <- lm(fvc_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=pre2015)
summary(FVC_model2a)
confint(FVC_model2a)
```

Complete model
```{r}
FVC_model2b <- lm(fvc_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=post2015)
summary(FVC_model2b)
confint(FVC_model2b)
```


### Pre/Post-2015 Only - OM 5yrs Pre-Diagnosis Low vs High and Baseline FVC
Looking at OM5yr_dich vs baseline FVC

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1a <- lm(fvc_pct ~ OM5yr_dich, data=pre2015)
summary(FVC_model1a)
confint(FVC_model1a)
```

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
FVC_model1b <- lm(fvc_pct ~ OM5yr_dich, data=post2015)
summary(FVC_model1b)
confint(FVC_model1b)
```

Complete model
```{r}
FVC_model2a <- lm(fvc_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=pre2015)
summary(FVC_model2a)
confint(FVC_model2a)
```

Complete model
```{r}
FVC_model2b <- lm(fvc_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=post2015)
summary(FVC_model2b)
confint(FVC_model2b)
```

# Pre/Post-2015 Only - Association between OM and Baseline DLCO
## Pre/Post-2015 Only - Visual EDA 5yrs pre-Dx
Scatterplot of continuous OM 5yrs pre-diagnosis vs DLCO, with sex represented by the color of points - Pre-2015
```{r}
(pre2015 %>% ggplot(aes(x=OM_5yrPreDx, y=dlco_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(5,20))
```

Scatterplot of continuous OM 5yrs pre-diagnosis vs DLCO, with sex represented by the color of points - Post-2015
```{r}
(post2015 %>% ggplot(aes(x=OM_5yrPreDx, y=dlco_pct, color=sex))+
   geom_point()+
   labs(x="OM 5yrs Pre-Diagnosis", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis")+
   geom_smooth(method="lm", se = FALSE) +
   theme(plot.title = element_text(hjust = 0.5))+
   xlim(5,20))
```

Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs DLCO - Pre-2015
```{r}
(pre2015b %>% ggplot(aes(x=OM5yr_dich, y=dlco_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```

Violin plot wrapping boxplot to visualize OM 5yrs pre-dx low vs high vs DLCO - Post-2015
```{r}
(post2015b %>% ggplot(aes(x=OM5yr_dich, y=dlco_pct, fill=OM5yr_dich))+
   geom_boxplot(width=0.2, color="black", alpha=1.0)+
   geom_violin(width=1.0, alpha=0.5)+
   labs(x="OM 5yrs Pre-Diagnosis Low vs High", y="Baseline DLCO % Predicted", title="Baseline DLCO % Predicted by OM 5yrs Pre-Diagnosis Low vs High")+
   theme_light()+
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5))+
   scale_fill_brewer(type="seq", palette="YlOrRd"))
```

## Pre/Post-2015 Only - OM 5yrs Pre-Diagnosis and DLCO Models
### Pre/Post-2015 Only - OM 5yrs Pre-Diagnosis and Baseline DLCO
Looking at continuous OM_5yrPreDx vs baseline DLCO

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1a <- lm(dlco_pct ~ OM_5yrPreDx, data=pre2015)
summary(DLCO_model1a)
confint(DLCO_model1a)
```

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1b <- lm(dlco_pct ~ OM_5yrPreDx, data=post2015)
summary(DLCO_model1b)
confint(DLCO_model1b)
```

Complete model
```{r}
DLCO_model2a <- lm(dlco_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=pre2015)
summary(DLCO_model2a)
confint(DLCO_model2a)
```

Complete model
```{r}
DLCO_model2b <- lm(dlco_pct ~ OM_5yrPreDx + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=post2015)
summary(DLCO_model2b)
confint(DLCO_model2b)
```

### Pre/Post-2015 Only - OM 5yrs Pre-Diagnosis Low vs High and Baseline DLCO
Looking at OM5yr_dich vs baseline DLCO

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1a <- lm(dlco_pct ~ OM5yr_dich, data=pre2015)
summary(DLCO_model1a)
confint(DLCO_model1a)
```

Simplest model just looking at OM in 5yrs pre-diagnosis
```{r}
DLCO_model1b <- lm(dlco_pct ~ OM5yr_dich, data=post2015)
summary(DLCO_model1b)
confint(DLCO_model1b)
```

Complete model
```{r}
DLCO_model2a <- lm(dlco_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=pre2015)
summary(DLCO_model2a)
confint(DLCO_model2a)
```

Complete model
```{r}
DLCO_model2b <- lm(dlco_pct ~ OM5yr_dich + sex + age_dx + smokeHx + dich_Race + avg_s + site, data=post2015)
summary(DLCO_model2b)
confint(DLCO_model2b)
```



