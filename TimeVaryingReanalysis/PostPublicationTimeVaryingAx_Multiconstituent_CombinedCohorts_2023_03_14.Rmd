---
title: "Multi-Constituent Analysis with All Cohorts - Post-Publication Time-Weighted Analysis"
author: "Gillian Goobie"
date: "2023/01/02"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)
```

```{r, message=FALSE, warning=FALSE, echo=F}
library(tidyverse)
library(readxl)
library(here)
library(writexl)
library(knitr)
library(lintr)
library(tidync)
library(maps)
library(ncmeta)
library(devtools)
library(RNetCDF)
library(ncdf4)
library(survival)
library(survminer)
library(lubridate)
library(cmprsk)
library(riskRegression)
library(prodlim)
library(RColorBrewer)
library(prodlim)
library(lme4)
library(performance)
library(psycho)
library(report)
library(rms)
library(splines)
library(Greg)
library(rstpm2)
library(pspline)
library(raster)
library(data.table)
library(intervalaverage)
library(qgcomp)
```

# Simmons - Importing Datasets
Here I am importing the file which contains monthly PM level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simmons_fILD_2000_2018_PM25_2021_09_08.xlsx")
PM <- read_excel(outfile1)
```

Here I am importing the file which I used for my ADI work that contains the baseline clinical and demographic data for 1425 patients who have ADI
```{r}
outfile2 <- here("Simmons_fILDPts_BaselineData_2022_03_28.xlsx")
Simm <- read_excel(outfile2)
```

# Simmons - Simplifying PM Dataframe
```{r}
PM <- PM %>% dplyr::select(!c(nrow, dist, lon, lat))
colnames(PM)
```

```{r}
PM <- PM %>% 
  pivot_longer(cols=c(2:228), names_to="PM_date", names_prefix="PM25_")
```

```{r}
PMx <- PM 
PMx$PM_date <- gsub("jan", "01-01-20", PMx$PM_date)
PMx$PM_date <- gsub("feb", "01-02-20", PMx$PM_date)
PMx$PM_date <- gsub("mar", "01-03-20", PMx$PM_date)
PMx$PM_date <- gsub("apr", "01-04-20", PMx$PM_date)
PMx$PM_date <- gsub("may", "01-05-20", PMx$PM_date)
PMx$PM_date <- gsub("jun", "01-06-20", PMx$PM_date)
PMx$PM_date <- gsub("jul", "01-07-20", PMx$PM_date)
PMx$PM_date <- gsub("aug", "01-08-20", PMx$PM_date)
PMx$PM_date <- gsub("sep", "01-09-20", PMx$PM_date)
PMx$PM_date <- gsub("oct", "01-10-20", PMx$PM_date)
PMx$PM_date <- gsub("nov", "01-11-20", PMx$PM_date)
PMx$PM_date <- gsub("dec", "01-12-20", PMx$PM_date)

PMx$PM_date <- format(as.Date(PMx$PM_date, format="%d-%m-%Y"),"%Y-%m-%d")
PMx$PM_date <- as.Date(PMx$PM_date)
PM <- PMx
rm(PMx)
```


# Simmons - Simplifying Simm Dataframe
## Simmons - Death/Transplant/Censoring Date
Extracting year of diagnosis and year of death/transplant/censoring
```{r}
#Start with the year of diagnosis
Simm <- Simm %>% 
  mutate(dx_yrmo = format(as.Date(Simm$dx_date, format="%Y-%m-%d"),"%Y-%m"))
Simm <- Simm %>% 
  mutate(dx_yr = format(as.Date(Simm$dx_date, format="%Y-%m-%d"),"%Y"))
Simm$dx_yr <- as.numeric(Simm$dx_yr)

#Then the year of death or lung transplant
Simm <- Simm %>% 
  mutate(deathORtx_date = if_else(!is.na(tx_date), tx_date, death_date))
Simm <- Simm %>% 
  mutate(deathORtx_yrmo = format(as.Date(Simm$deathORtx_date, format="%Y-%m-%d"),"%Y-%m"))

#Then the year the records were last updated (i.e. year of censoring)
Simm <- Simm %>% 
  mutate(DeathTxCensor_date = if_else(!is.na(deathORtx_date), deathORtx_date, last_updated))
Simm <- Simm %>% 
  mutate(censor_yrmo = format(as.Date(Simm$DeathTxCensor_date, format="%Y-%m-%d"),"%Y-%m"))
```

## Simmons - Removing Unnecessary Columns and Correcting Dates
```{r}
Simm <- Simm %>% dplyr::select(!c(ADI_state, lat, lon, City, State, zip5, UPMC_lastvisit, Simmons_lastvisit, pkyrs, fev1_pre, fev1_pct, fvc_pre, dlco_pre, pft_timefromdx, ethnicity, dx_type, deathORtx_date, deathORtx_yrmo))
Simm <- Simm %>% 
  mutate_at(c("dob","death_date", "last_updated", "tx_date", "dx_date", "consent_date", "pft_date", "DeathTxCensor_date"), as.Date)
str(Simm)
```

## Simmons - Correcting Smoking
Need to correct smoking variables
```{r}
Simm$smokeHx <- as.character(Simm$smokeHx) 
Simm <- Simm %>% mutate(smokeHx1=if_else(is.na(smokeHx), "Unknown", smokeHx))

#now need to make new dich_smoking category
Simm$dich_smoking <- as.character(Simm$dich_smoking) 
Simm <- Simm %>% mutate(dich_smoking1=if_else(is.na(dich_smoking),"Unknown", dich_smoking))
```

Now need to remove old smoking variables and rename new ones
```{r}
Simm <- Simm %>% dplyr::select(-c(smokeHx, dich_smoking))
Simm <- Simm %>% rename(c("smokeHx"="smokeHx1", "dich_smoking"="dich_smoking1"))
Simm$smokeHx <- as.factor(Simm$smokeHx)
Simm$dich_smoking <- as.factor(Simm$dich_smoking)
Simm$smokeHx <- fct_relevel(Simm$smokeHx, c("Never","Former","Always","Unknown"))
Simm$dich_smoking <- fct_relevel(Simm$dich_smoking, c("Never","Ever","Unknown"))
```

## Simmons - Correcting Factors
Need to correct other factor variables
```{r}
Simm$sex <- fct_relevel(Simm$sex, c("M","F"))
Simm$race <- fct_relevel(Simm$race, c("W","B","A","N","U"))
Simm$dich_Race <- fct_relevel(Simm$dich_Race, c("White","Non-White"))
Simm$dx <- fct_relevel(Simm$dx, c("IPF"))
Simm$dx_group <- fct_relevel(Simm$dx_group, c("IPF"))
Simm <- Simm %>% mutate_at(c("status","died", "txed", "deadORtx"), as.factor)
```

## Simmons - Creating New Variables
### Simmons - IPF vs Other Diagnosis
```{r}
Simm <- Simm %>% mutate(dx_IPF=ifelse(dx=="IPF", "IPF", "not_IPF"))  
Simm$dx_IPF <- fct_relevel(Simm$dx_IPF, c("IPF"))
```

### Simmons - Disadvantage Distribution
Creating this empirical cumulative distribution will allow us to combine the analyses of all three cohorts even though the measurements for disadvantage are different between the three.
```{r}
plot(ecdf(Simm$ADI_nat))
Simm$disadv <- ecdf(Simm$ADI_nat)(Simm$ADI_nat)
```




# Simmons - Modifying Simmons Dataset
Take down Simmons dataset to the 1424 patients with complete data (currently at 1425)
```{r}
IDs <- as.data.table(unique(PM$ID))
IDs <- IDs %>% rename("ID"="V1")
Simm <- left_join(IDs, Simm, by="ID")
```


```{r}
Simm <- Simm %>% mutate(days_DeathTxCensor=(time_DeathTxCensor*365.25))
```
Longest time_DeathTxCensor= 20.427105yrs =7461days

30-day longest time interval would be 7470 days
```{r}
start <- seq(1, 7441, by = 30)
start
end <- seq(30, 7470, by = 30)
end
```

Repeat the list of intervals 1424 times (number of patients in Simmons)
```{r}
start <- rep(start, times=1424)
end <- rep(end, times=1424)
intervals <- as.data.frame(cbind(start, end))
```

Add ID column to intervals
```{r}
IDs <- rep(Simm$ID, each=249)
intervals <- as.data.frame(cbind(IDs, intervals))
intervals <- intervals %>% rename("ID"="IDs")
```

Join Simm and intervals
```{r}
Simm <- left_join(intervals, Simm, by="ID")
```

Determine if event occurred during interval
```{r}
Simm <- Simm %>% mutate(event=if_else((days_DeathTxCensor>=start & days_DeathTxCensor<=end), 1, 0))
```

Now will add date intervals for 5yr start and end times)
```{r}
Simm <- Simm %>% mutate(end_5yr=(dx_date + days(end)))
Simm <- Simm %>% mutate(start_5yr=(end_5yr - days(1826)))
```

Now need to remove any rows where end_5yr is > date_DeathTxCensor (Amanda indicated need to remove rows where start_5yr > date_DeathTxCensor, but I don't think this is correct because then we'd be assigning exposures to patients where they were alive/not transplanted for <5yrs for that exposure - need to double check with her)
```{r}
Simm <- Simm %>% filter(!(end_5yr>DeathTxCensor_date & event!=1))
```



# Simmons - Creating Time-Weighted Intervals of Exposures
```{r}
PM <- PM %>% mutate(start=as.IDate(PM_date))
PM <- PM %>% mutate(end=as.IDate(PM_date + months(1) - days(1)))
PM <- as.data.table(PM)
str(PM)
```

Creating a list of intervals we want to calculate exposures for:
```{r}
Simm_intervals <- Simm %>% dplyr::select(ID, start_5yr, end_5yr)
Simm_intervals <- Simm_intervals %>% mutate_at(c("start_5yr", "end_5yr"), as.IDate)
Simm_intervals <- Simm_intervals %>% rename(c("start"="start_5yr", "end"="end_5yr"))
Simm_intervals <- as.data.table(Simm_intervals)
str(Simm_intervals)
```

```{r}
PM_5yrWtedAvg <- intervalaverage(x=PM,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
PM_5yrWtedAvgx <- PM_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
PM_5yrWtedAvgx <- PM_5yrWtedAvgx %>% rename("PM"="value", "start_5yr"="start", "end_5yr"="end")
PM_5yrWtedAvgx <- PM_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(PM_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, PM_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```


# Simmons SO4 - Importing SO4 Datasets
Here I am importing the file which contains monthly SO4 level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simmons_fILD_2000_2017_SO4_2021_11_07.xlsx")
SO4 <- read_excel(outfile1)
```


# Simmons SO4 - Simplifying SO4 Dataframe
```{r}
SO4 <- SO4 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
SO4 <- SO4 %>% 
  pivot_longer(cols=c(2:217), names_to="SO4_date", names_prefix="SO4_")
```

```{r}
SO4x <- SO4 
SO4x$SO4_date <- gsub("jan", "01-01-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("feb", "01-02-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("mar", "01-03-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("apr", "01-04-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("may", "01-05-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("jun", "01-06-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("jul", "01-07-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("aug", "01-08-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("sep", "01-09-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("oct", "01-10-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("nov", "01-11-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("dec", "01-12-20", SO4x$SO4_date)

SO4x$SO4_date <- format(as.Date(SO4x$SO4_date, format="%d-%m-%Y"),"%Y-%m-%d")
SO4x$SO4_date <- as.Date(SO4x$SO4_date)
SO4 <- SO4x
rm(SO4x)
```

# Simmons  SO4 - Creating Time-Weighted Intervals of Exposures
```{r}
SO4 <- SO4 %>% mutate(start=as.IDate(SO4_date))
SO4 <- SO4 %>% mutate(end=as.IDate(SO4_date + months(1) - days(1)))
SO4 <- as.data.table(SO4)
str(SO4)
```


```{r}
SO4_5yrWtedAvg <- intervalaverage(x=SO4,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
SO4_5yrWtedAvgx <- SO4_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
SO4_5yrWtedAvgx <- SO4_5yrWtedAvgx %>% rename("SO4"="value", "start_5yr"="start", "end_5yr"="end")
SO4_5yrWtedAvgx <- SO4_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(SO4_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, SO4_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# Simmons NO3 - Importing NO3 Datasets
Here I am importing the file which contains monthly NO3 level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simm_fILD_2000_2017_NO3_2021_11_05.xlsx")
NO3 <- read_excel(outfile1)
```


# Simmons NO3 - Simplifying NO3 Dataframe
```{r}
NO3 <- NO3 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
NO3 <- NO3 %>% 
  pivot_longer(cols=c(2:217), names_to="NO3_date", names_prefix="NIT_")
```

```{r}
NO3x <- NO3 
NO3x$NO3_date <- gsub("jan", "01-01-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("feb", "01-02-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("mar", "01-03-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("apr", "01-04-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("may", "01-05-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("jun", "01-06-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("jul", "01-07-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("aug", "01-08-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("sep", "01-09-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("oct", "01-10-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("nov", "01-11-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("dec", "01-12-20", NO3x$NO3_date)

NO3x$NO3_date <- format(as.Date(NO3x$NO3_date, format="%d-%m-%Y"),"%Y-%m-%d")
NO3x$NO3_date <- as.Date(NO3x$NO3_date)
NO3 <- NO3x
rm(NO3x)
```

# Simmons  NO3 - Creating Time-Weighted Intervals of Exposures
```{r}
NO3 <- NO3 %>% mutate(start=as.IDate(NO3_date))
NO3 <- NO3 %>% mutate(end=as.IDate(NO3_date + months(1) - days(1)))
NO3 <- as.data.table(NO3)
str(NO3)
```


```{r}
NO3_5yrWtedAvg <- intervalaverage(x=NO3,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
NO3_5yrWtedAvgx <- NO3_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
NO3_5yrWtedAvgx <- NO3_5yrWtedAvgx %>% rename("NO3"="value", "start_5yr"="start", "end_5yr"="end")
NO3_5yrWtedAvgx <- NO3_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(NO3_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, NO3_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# Simmons NH4 - Importing NH4 Datasets
Here I am importing the file which contains monthly NH4 level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simm_fILD_2000_2017_NH4_2021_11_05.xlsx")
NH4 <- read_excel(outfile1)
```


# Simmons NH4 - Simplifying NH4 Dataframe
```{r}
NH4 <- NH4 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
NH4 <- NH4 %>% 
  pivot_longer(cols=c(2:217), names_to="NH4_date", names_prefix="NH4_")
```

```{r}
NH4x <- NH4 
NH4x$NH4_date <- gsub("jan", "01-01-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("feb", "01-02-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("mar", "01-03-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("apr", "01-04-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("may", "01-05-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("jun", "01-06-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("jul", "01-07-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("aug", "01-08-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("sep", "01-09-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("oct", "01-10-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("nov", "01-11-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("dec", "01-12-20", NH4x$NH4_date)

NH4x$NH4_date <- format(as.Date(NH4x$NH4_date, format="%d-%m-%Y"),"%Y-%m-%d")
NH4x$NH4_date <- as.Date(NH4x$NH4_date)
NH4 <- NH4x
rm(NH4x)
```

# Simmons  NH4 - Creating Time-Weighted Intervals of Exposures
```{r}
NH4 <- NH4 %>% mutate(start=as.IDate(NH4_date))
NH4 <- NH4 %>% mutate(end=as.IDate(NH4_date + months(1) - days(1)))
NH4 <- as.data.table(NH4)
str(NH4)
```


```{r}
NH4_5yrWtedAvg <- intervalaverage(x=NH4,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
NH4_5yrWtedAvgx <- NH4_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
NH4_5yrWtedAvgx <- NH4_5yrWtedAvgx %>% rename("NH4"="value", "start_5yr"="start", "end_5yr"="end")
NH4_5yrWtedAvgx <- NH4_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(NH4_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, NH4_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# Simmons BC - Importing BC Datasets
Here I am importing the file which contains monthly BC level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simm_fILD_2000_2017_BC_2021_11_05.xlsx")
BC <- read_excel(outfile1)
```


# Simmons BC - Simplifying BC Dataframe
```{r}
BC <- BC %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
BC <- BC %>% 
  pivot_longer(cols=c(2:217), names_to="BC_date", names_prefix="BC_")
```

```{r}
BCx <- BC 
BCx$BC_date <- gsub("jan", "01-01-20", BCx$BC_date)
BCx$BC_date <- gsub("feb", "01-02-20", BCx$BC_date)
BCx$BC_date <- gsub("mar", "01-03-20", BCx$BC_date)
BCx$BC_date <- gsub("apr", "01-04-20", BCx$BC_date)
BCx$BC_date <- gsub("may", "01-05-20", BCx$BC_date)
BCx$BC_date <- gsub("jun", "01-06-20", BCx$BC_date)
BCx$BC_date <- gsub("jul", "01-07-20", BCx$BC_date)
BCx$BC_date <- gsub("aug", "01-08-20", BCx$BC_date)
BCx$BC_date <- gsub("sep", "01-09-20", BCx$BC_date)
BCx$BC_date <- gsub("oct", "01-10-20", BCx$BC_date)
BCx$BC_date <- gsub("nov", "01-11-20", BCx$BC_date)
BCx$BC_date <- gsub("dec", "01-12-20", BCx$BC_date)

BCx$BC_date <- format(as.Date(BCx$BC_date, format="%d-%m-%Y"),"%Y-%m-%d")
BCx$BC_date <- as.Date(BCx$BC_date)
BC <- BCx
rm(BCx)
```

# Simmons  BC - Creating Time-Weighted Intervals of Exposures
```{r}
BC <- BC %>% mutate(start=as.IDate(BC_date))
BC <- BC %>% mutate(end=as.IDate(BC_date + months(1) - days(1)))
BC <- as.data.table(BC)
str(BC)
```


```{r}
BC_5yrWtedAvg <- intervalaverage(x=BC,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
BC_5yrWtedAvgx <- BC_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
BC_5yrWtedAvgx <- BC_5yrWtedAvgx %>% rename("BC"="value", "start_5yr"="start", "end_5yr"="end")
BC_5yrWtedAvgx <- BC_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(BC_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, BC_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# Simmons OM - Importing OM Datasets
Here I am importing the file which contains monthly OM level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simm_fILD_2000_2017_OM_2021_11_05.xlsx")
OM <- read_excel(outfile1)
```


# Simmons OM - Simplifying OM Dataframe
```{r}
OM <- OM %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
OM <- OM %>% 
  pivot_longer(cols=c(2:217), names_to="OM_date", names_prefix="OM_")
```

```{r}
OMx <- OM 
OMx$OM_date <- gsub("jan", "01-01-20", OMx$OM_date)
OMx$OM_date <- gsub("feb", "01-02-20", OMx$OM_date)
OMx$OM_date <- gsub("mar", "01-03-20", OMx$OM_date)
OMx$OM_date <- gsub("apr", "01-04-20", OMx$OM_date)
OMx$OM_date <- gsub("may", "01-05-20", OMx$OM_date)
OMx$OM_date <- gsub("jun", "01-06-20", OMx$OM_date)
OMx$OM_date <- gsub("jul", "01-07-20", OMx$OM_date)
OMx$OM_date <- gsub("aug", "01-08-20", OMx$OM_date)
OMx$OM_date <- gsub("sep", "01-09-20", OMx$OM_date)
OMx$OM_date <- gsub("oct", "01-10-20", OMx$OM_date)
OMx$OM_date <- gsub("nov", "01-11-20", OMx$OM_date)
OMx$OM_date <- gsub("dec", "01-12-20", OMx$OM_date)

OMx$OM_date <- format(as.Date(OMx$OM_date, format="%d-%m-%Y"),"%Y-%m-%d")
OMx$OM_date <- as.Date(OMx$OM_date)
OM <- OMx
rm(OMx)
```

# Simmons  OM - Creating Time-Weighted Intervals of Exposures
```{r}
OM <- OM %>% mutate(start=as.IDate(OM_date))
OM <- OM %>% mutate(end=as.IDate(OM_date + months(1) - days(1)))
OM <- as.data.table(OM)
str(OM)
```


```{r}
OM_5yrWtedAvg <- intervalaverage(x=OM,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
OM_5yrWtedAvgx <- OM_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
OM_5yrWtedAvgx <- OM_5yrWtedAvgx %>% rename("OM"="value", "start_5yr"="start", "end_5yr"="end")
OM_5yrWtedAvgx <- OM_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(OM_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, OM_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# Simmons SS - Importing SS Datasets
Here I am importing the file which contains monthly SS level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simm_fILD_2000_2017_SS_2021_11_05.xlsx")
SS <- read_excel(outfile1)
```


# Simmons SS - Simplifying SS Dataframe
```{r}
SS <- SS %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
SS <- SS %>% 
  pivot_longer(cols=c(2:217), names_to="SS_date", names_prefix="SS_")
```

```{r}
SSx <- SS 
SSx$SS_date <- gsub("jan", "01-01-20", SSx$SS_date)
SSx$SS_date <- gsub("feb", "01-02-20", SSx$SS_date)
SSx$SS_date <- gsub("mar", "01-03-20", SSx$SS_date)
SSx$SS_date <- gsub("apr", "01-04-20", SSx$SS_date)
SSx$SS_date <- gsub("may", "01-05-20", SSx$SS_date)
SSx$SS_date <- gsub("jun", "01-06-20", SSx$SS_date)
SSx$SS_date <- gsub("jul", "01-07-20", SSx$SS_date)
SSx$SS_date <- gsub("aug", "01-08-20", SSx$SS_date)
SSx$SS_date <- gsub("sep", "01-09-20", SSx$SS_date)
SSx$SS_date <- gsub("oct", "01-10-20", SSx$SS_date)
SSx$SS_date <- gsub("nov", "01-11-20", SSx$SS_date)
SSx$SS_date <- gsub("dec", "01-12-20", SSx$SS_date)

SSx$SS_date <- format(as.Date(SSx$SS_date, format="%d-%m-%Y"),"%Y-%m-%d")
SSx$SS_date <- as.Date(SSx$SS_date)
SS <- SSx
rm(SSx)
```

# Simmons  SS - Creating Time-Weighted Intervals of Exposures
```{r}
SS <- SS %>% mutate(start=as.IDate(SS_date))
SS <- SS %>% mutate(end=as.IDate(SS_date + months(1) - days(1)))
SS <- as.data.table(SS)
str(SS)
```


```{r}
SS_5yrWtedAvg <- intervalaverage(x=SS,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
SS_5yrWtedAvgx <- SS_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
SS_5yrWtedAvgx <- SS_5yrWtedAvgx %>% rename("SS"="value", "start_5yr"="start", "end_5yr"="end")
SS_5yrWtedAvgx <- SS_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(SS_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, SS_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# Simmons Soil - Importing Soil Datasets
Here I am importing the file which contains monthly Soil level estimates by satellite at nearest lon/lat to Simmons patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("Simm_fILD_2000_2017_Soil_2021_11_05.xlsx")
Soil <- read_excel(outfile1)
```


# Simmons Soil - Simplifying Soil Dataframe
```{r}
Soil <- Soil %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
Soil <- Soil %>% 
  pivot_longer(cols=c(2:217), names_to="Soil_date", names_prefix="soil_")
```

```{r}
Soilx <- Soil 
Soilx$Soil_date <- gsub("jan", "01-01-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("feb", "01-02-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("mar", "01-03-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("apr", "01-04-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("may", "01-05-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("jun", "01-06-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("jul", "01-07-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("aug", "01-08-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("sep", "01-09-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("oct", "01-10-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("nov", "01-11-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("dec", "01-12-20", Soilx$Soil_date)

Soilx$Soil_date <- format(as.Date(Soilx$Soil_date, format="%d-%m-%Y"),"%Y-%m-%d")
Soilx$Soil_date <- as.Date(Soilx$Soil_date)
Soil <- Soilx
rm(Soilx)
```

# Simmons  Soil - Creating Time-Weighted Intervals of Exposures
```{r}
Soil <- Soil %>% mutate(start=as.IDate(Soil_date))
Soil <- Soil %>% mutate(end=as.IDate(Soil_date + months(1) - days(1)))
Soil <- as.data.table(Soil)
str(Soil)
```


```{r}
Soil_5yrWtedAvg <- intervalaverage(x=Soil,
                y=Simm_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
Soil_5yrWtedAvgx <- Soil_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
Soil_5yrWtedAvgx <- Soil_5yrWtedAvgx %>% rename("Soil"="value", "start_5yr"="start", "end_5yr"="end")
Soil_5yrWtedAvgx <- Soil_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(Soil_5yrWtedAvgx)
```

Join to Simm
```{r}
Simm <- left_join(Simm, Soil_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF - Importing Datasets
Here I am importing the file which contains monthly PM level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2018_PM25_2021_10_08.xlsx")
PM <- read_excel(outfile1)
PM <- PM %>% rename("SSID"="ID")
```

Match up PM ID to SSID from matching file
```{r}
outfile2 <- here("PFF_fILD_PM25_BaselineData_2021_10_20.xlsx")
PM25 <- read_excel(outfile2)
PM25 <- PM25 %>% dplyr::select(ID, SSID)
```

Merge PM and PM
```{r}
PM <- left_join(PM, PM25, by="SSID")
```


Here I am importing the file containing the complete baseline clinical and demographic data for 1905 PFF patients
```{r}
outfile3 <- here("PFF_fILDPts_BaselineData_ConsentDateReference_2022_08_01.xlsx")
PFF <- read_excel(outfile3)
```

# PFF - Merging Datasets
I used a inner_join here so that the complete "PFF" dataframe only includes patients with fILD that have all baseline demographics and PM data.
```{r}
PFF <- inner_join(PFF, PM, by="SSID")
```
This results in 1905 complete records

Reorder so "ID" is the first column
```{r}
PFF <- PFF %>% dplyr::select(ID, everything(.))
```

# PFF - Making dx_yr column
```{r}
PFF <- PFF %>% 
  mutate(dx_yr = format(as.Date(PFF$dx_date, format="%Y-%m-%d"),"%Y"))
PFF$dx_yr <- as.numeric(PFF$dx_yr)
```

# PFF - Creating Site Variable
```{r}
PFF$site <- substr(PFF$SSID, 1,3)
PFF$site <- as.factor(PFF$site)
str(PFF$site)
```

Removing Pittsburgh site
```{r}
PFF <- PFF %>% filter(!site=="08R")
```



# PFF - Simplifying PM Dataframe
Reorder so "ID" is the first column
```{r}
PM <- PM %>% dplyr::select(ID, everything(.))
PM <- PM %>% dplyr::select(!SSID)
```

```{r}
PM <- PM %>% dplyr::select(!c(nrow, dist, lon, lat))
colnames(PM)
```

```{r}
PM <- PM %>% 
  pivot_longer(cols=c(2:228), names_to="PM_date", names_prefix="PM25_")
```

```{r}
PMx <- PM 
PMx$PM_date <- gsub("jan", "01-01-20", PMx$PM_date)
PMx$PM_date <- gsub("feb", "01-02-20", PMx$PM_date)
PMx$PM_date <- gsub("mar", "01-03-20", PMx$PM_date)
PMx$PM_date <- gsub("apr", "01-04-20", PMx$PM_date)
PMx$PM_date <- gsub("may", "01-05-20", PMx$PM_date)
PMx$PM_date <- gsub("jun", "01-06-20", PMx$PM_date)
PMx$PM_date <- gsub("jul", "01-07-20", PMx$PM_date)
PMx$PM_date <- gsub("aug", "01-08-20", PMx$PM_date)
PMx$PM_date <- gsub("sep", "01-09-20", PMx$PM_date)
PMx$PM_date <- gsub("oct", "01-10-20", PMx$PM_date)
PMx$PM_date <- gsub("nov", "01-11-20", PMx$PM_date)
PMx$PM_date <- gsub("dec", "01-12-20", PMx$PM_date)

PMx$PM_date <- format(as.Date(PMx$PM_date, format="%d-%m-%Y"),"%Y-%m-%d")
PMx$PM_date <- as.Date(PMx$PM_date)
PM <- PMx
rm(PMx)
```


# PFF - Simplifying PFF Dataframe
## PFF - Death/Transplant/Censor Date
Extracting year of diagnosis and year of death/transplant/censoring
```{r}
#Start with the year of diagnosis
PFF <- PFF %>% 
  mutate(dx_yrmo = format(as.Date(PFF$dx_date, format="%Y-%m-%d"),"%Y-%m"))
PFF <- PFF %>% 
  mutate(dx_yr = format(as.Date(PFF$dx_date, format="%Y-%m-%d"),"%Y"))
PFF$dx_yr <- as.numeric(PFF$dx_yr)

#Then the year of death or lung transplant
PFF <- PFF %>% 
  mutate(deathORtx_date = if_else(!is.na(tx_date), tx_date, death_date))
PFF <- PFF %>% 
  mutate(deathORtx_yrmo = format(as.Date(PFF$deathORtx_date, format="%Y-%m-%d"),"%Y-%m"))

#Then the year the records were last updated (i.e. year of censoring)
PFF <- PFF %>% 
  mutate(DeathTxCensor_date = if_else(!is.na(deathORtx_date), deathORtx_date, censor_date))
PFF <- PFF %>% 
  mutate(censor_yrmo = format(as.Date(PFF$DeathTxCensor_date, format="%Y-%m-%d"),"%Y-%m"))
```

## PFF - Removing Unnecessary Columns and Correcting Dates
```{r}
PFF <- PFF %>% dplyr::select(c(ID, site, age_dx, sex, smokeHx, race, dich_Race, pct_belowpoverty, dx_group, dx, dx_date, death_date, tx_date, DeathTxCensor_date, censor_date, fvc_date, dlco_date, fvc_pct, dlco_pct, status, deadORtx, time_DeathTxCensor, dx_yr))
PFF <- PFF %>% 
  mutate_at(c("death_date", "censor_date", "tx_date", "dx_date", "fvc_date", "dlco_date", "DeathTxCensor_date"), as.Date)
str(PFF)
```

## PFF - Correcting Smoking
Need to correct smoking variables
```{r}
PFF$smokeHx <- as.character(PFF$smokeHx) 
PFF <- PFF %>% mutate(smokeHx1=if_else(is.na(smokeHx), "Unknown", smokeHx))

```

Now need to remove old smoking variables and rename new ones
```{r}
PFF <- PFF %>% dplyr::select(-c(smokeHx))
PFF <- PFF %>% rename(c("smokeHx"="smokeHx1"))
PFF$smokeHx <- as.factor(PFF$smokeHx)
PFF$smokeHx <- fct_relevel(PFF$smokeHx, c("Never","Ever","Unknown"))
```

## PFF - Correcting Factors
Need to correct other factor variables
```{r}
PFF$sex <- fct_relevel(PFF$sex, c("M","F"))
PFF$race <- fct_relevel(PFF$race, c("W","B","A","N","U"))
PFF$dich_Race <- fct_relevel(PFF$dich_Race, c("White","Non-White"))
PFF$dx <- fct_relevel(PFF$dx, c("IPF"))
PFF$dx_group <- fct_relevel(PFF$dx_group, c("IPF"))
PFF <- PFF %>% mutate_at(c("status", "site"), as.factor)
```

## PFF - Creating New Variables
### PFF - IPF vs Other Diagnosis
```{r}
PFF <- PFF %>% mutate(dx_IPF=ifelse(dx=="IPF", "IPF", "not_IPF"))  
PFF$dx_IPF <- fct_relevel(PFF$dx_IPF, c("IPF"))
```

### PFF - Disadvantage Distribution
Creating this empirical cumulative distribution will allow us to combine the analyses of all three cohorts even though the measurements for disadvantage are different between the three.
```{r}
plot(ecdf(PFF$pct_belowpoverty))
PFF$disadv <- ecdf(PFF$pct_belowpoverty)(PFF$pct_belowpoverty)
```

# PFF - Modifying PFF Dataset
Take down PFF dataset to the 1905 patients with complete data
```{r}
IDs <- as.data.table(unique(PM$ID))
IDs <- IDs %>% rename("ID"="V1")
PFF <- left_join(IDs, PFF, by="ID")
```


```{r}
PFF <- PFF %>% mutate(days_DeathTxCensor=(time_DeathTxCensor*365.25))
```
Longest time_DeathTxCensor= 1848days

30-day longest time interval would be 1860 days
```{r}
start <- seq(1, 1831, by = 30)
start
end <- seq(30, 1860, by = 30)
end
```

Repeat the list of intervals 1905 times (number of patients in PFF)
```{r}
start <- rep(start, times=1905)
end <- rep(end, times=1905)
intervals <- as.data.frame(cbind(start, end))
```

Add ID column to intervals
```{r}
IDs <- rep(PFF$ID, each=62)
intervals <- as.data.frame(cbind(IDs, intervals))
intervals <- intervals %>% rename("ID"="IDs")
```

Join PFF and intervals
```{r}
PFF <- left_join(intervals, PFF, by="ID")
```

Determine if event occurred during interval
```{r}
PFF <- PFF %>% mutate(event=if_else((days_DeathTxCensor>=start & days_DeathTxCensor<=end), 1, 0))
```

Now will add date intervals for 5yr start and end times)
```{r}
PFF <- PFF %>% mutate(end_5yr=(dx_date + days(end)))
PFF <- PFF %>% mutate(start_5yr=(end_5yr - days(1826)))
```

Now need to remove any rows where end_5yr is > date_DeathTxCensor (Amanda indicated need to remove rows where start_5yr > date_DeathTxCensor, but I don't think this is correct because then we'd be assigning exposures to patients where they were alive/not transplanted for <5yrs for that exposure - need to double check with her)
```{r}
PFF <- PFF %>% filter(!(end_5yr>DeathTxCensor_date & event!=1))
```



# PFF - Creating Time-Weighted Intervals of Exposures
```{r}
PM <- PM %>% mutate(start=as.IDate(PM_date))
PM <- PM %>% mutate(end=as.IDate(PM_date + months(1) - days(1)))
PM <- as.data.table(PM)
str(PM)
```

Creating a list of intervals we want to calculate exposures for:
```{r}
PFF_intervals <- PFF %>% dplyr::select(ID, start_5yr, end_5yr)
PFF_intervals <- PFF_intervals %>% mutate_at(c("start_5yr", "end_5yr"), as.IDate)
PFF_intervals <- PFF_intervals %>% rename(c("start"="start_5yr", "end"="end_5yr"))
PFF_intervals <- as.data.table(PFF_intervals)
str(PFF_intervals)
```

```{r}
PM_5yrWtedAvg <- intervalaverage(x=PM,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
PM_5yrWtedAvgx <- PM_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
PM_5yrWtedAvgx <- PM_5yrWtedAvgx %>% rename("PM"="value", "start_5yr"="start", "end_5yr"="end")
PM_5yrWtedAvgx <- PM_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(PM_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, PM_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF SO4 - Importing SO4 Datasets
Here I am importing the file which contains monthly SO4 level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_SO4_2021_11_05.xlsx")
SO4 <- read_excel(outfile1)
```


# PFF SO4 - Simplifying SO4 Dataframe
```{r}
SO4 <- SO4 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
SO4 <- SO4 %>% 
  pivot_longer(cols=c(2:217), names_to="SO4_date", names_prefix="SO4_")
```

```{r}
SO4x <- SO4 
SO4x$SO4_date <- gsub("jan", "01-01-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("feb", "01-02-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("mar", "01-03-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("apr", "01-04-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("may", "01-05-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("jun", "01-06-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("jul", "01-07-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("aug", "01-08-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("sep", "01-09-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("oct", "01-10-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("nov", "01-11-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("dec", "01-12-20", SO4x$SO4_date)

SO4x$SO4_date <- format(as.Date(SO4x$SO4_date, format="%d-%m-%Y"),"%Y-%m-%d")
SO4x$SO4_date <- as.Date(SO4x$SO4_date)
SO4 <- SO4x
rm(SO4x)
```

# PFF  SO4 - Creating Time-Weighted Intervals of Exposures
```{r}
SO4 <- SO4 %>% mutate(start=as.IDate(SO4_date))
SO4 <- SO4 %>% mutate(end=as.IDate(SO4_date + months(1) - days(1)))
SO4 <- as.data.table(SO4)
str(SO4)
```


```{r}
SO4_5yrWtedAvg <- intervalaverage(x=SO4,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
SO4_5yrWtedAvgx <- SO4_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
SO4_5yrWtedAvgx <- SO4_5yrWtedAvgx %>% rename("SO4"="value", "start_5yr"="start", "end_5yr"="end")
SO4_5yrWtedAvgx <- SO4_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(SO4_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, SO4_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF NO3 - Importing NO3 Datasets
Here I am importing the file which contains monthly NO3 level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_NO3_2021_11_05.xlsx")
NO3 <- read_excel(outfile1)
```


# PFF NO3 - Simplifying NO3 Dataframe
```{r}
NO3 <- NO3 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
NO3 <- NO3 %>% 
  pivot_longer(cols=c(2:217), names_to="NO3_date", names_prefix="NIT_")
```

```{r}
NO3x <- NO3 
NO3x$NO3_date <- gsub("jan", "01-01-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("feb", "01-02-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("mar", "01-03-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("apr", "01-04-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("may", "01-05-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("jun", "01-06-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("jul", "01-07-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("aug", "01-08-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("sep", "01-09-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("oct", "01-10-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("nov", "01-11-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("dec", "01-12-20", NO3x$NO3_date)

NO3x$NO3_date <- format(as.Date(NO3x$NO3_date, format="%d-%m-%Y"),"%Y-%m-%d")
NO3x$NO3_date <- as.Date(NO3x$NO3_date)
NO3 <- NO3x
rm(NO3x)
```

# PFF  NO3 - Creating Time-Weighted Intervals of Exposures
```{r}
NO3 <- NO3 %>% mutate(start=as.IDate(NO3_date))
NO3 <- NO3 %>% mutate(end=as.IDate(NO3_date + months(1) - days(1)))
NO3 <- as.data.table(NO3)
str(NO3)
```


```{r}
NO3_5yrWtedAvg <- intervalaverage(x=NO3,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
NO3_5yrWtedAvgx <- NO3_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
NO3_5yrWtedAvgx <- NO3_5yrWtedAvgx %>% rename("NO3"="value", "start_5yr"="start", "end_5yr"="end")
NO3_5yrWtedAvgx <- NO3_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(NO3_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, NO3_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF NH4 - Importing NH4 Datasets
Here I am importing the file which contains monthly NH4 level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_NH4_2021_11_05.xlsx")
NH4 <- read_excel(outfile1)
```


# PFF NH4 - Simplifying NH4 Dataframe
```{r}
NH4 <- NH4 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
NH4 <- NH4 %>% 
  pivot_longer(cols=c(2:217), names_to="NH4_date", names_prefix="NH4_")
```

```{r}
NH4x <- NH4 
NH4x$NH4_date <- gsub("jan", "01-01-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("feb", "01-02-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("mar", "01-03-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("apr", "01-04-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("may", "01-05-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("jun", "01-06-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("jul", "01-07-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("aug", "01-08-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("sep", "01-09-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("oct", "01-10-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("nov", "01-11-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("dec", "01-12-20", NH4x$NH4_date)

NH4x$NH4_date <- format(as.Date(NH4x$NH4_date, format="%d-%m-%Y"),"%Y-%m-%d")
NH4x$NH4_date <- as.Date(NH4x$NH4_date)
NH4 <- NH4x
rm(NH4x)
```

# PFF  NH4 - Creating Time-Weighted Intervals of Exposures
```{r}
NH4 <- NH4 %>% mutate(start=as.IDate(NH4_date))
NH4 <- NH4 %>% mutate(end=as.IDate(NH4_date + months(1) - days(1)))
NH4 <- as.data.table(NH4)
str(NH4)
```


```{r}
NH4_5yrWtedAvg <- intervalaverage(x=NH4,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
NH4_5yrWtedAvgx <- NH4_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
NH4_5yrWtedAvgx <- NH4_5yrWtedAvgx %>% rename("NH4"="value", "start_5yr"="start", "end_5yr"="end")
NH4_5yrWtedAvgx <- NH4_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(NH4_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, NH4_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF BC - Importing BC Datasets
Here I am importing the file which contains monthly BC level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_BC_2021_11_05.xlsx")
BC <- read_excel(outfile1)
```


# PFF BC - Simplifying BC Dataframe
```{r}
BC <- BC %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
BC <- BC %>% 
  pivot_longer(cols=c(2:217), names_to="BC_date", names_prefix="BC_")
```

```{r}
BCx <- BC 
BCx$BC_date <- gsub("jan", "01-01-20", BCx$BC_date)
BCx$BC_date <- gsub("feb", "01-02-20", BCx$BC_date)
BCx$BC_date <- gsub("mar", "01-03-20", BCx$BC_date)
BCx$BC_date <- gsub("apr", "01-04-20", BCx$BC_date)
BCx$BC_date <- gsub("may", "01-05-20", BCx$BC_date)
BCx$BC_date <- gsub("jun", "01-06-20", BCx$BC_date)
BCx$BC_date <- gsub("jul", "01-07-20", BCx$BC_date)
BCx$BC_date <- gsub("aug", "01-08-20", BCx$BC_date)
BCx$BC_date <- gsub("sep", "01-09-20", BCx$BC_date)
BCx$BC_date <- gsub("oct", "01-10-20", BCx$BC_date)
BCx$BC_date <- gsub("nov", "01-11-20", BCx$BC_date)
BCx$BC_date <- gsub("dec", "01-12-20", BCx$BC_date)

BCx$BC_date <- format(as.Date(BCx$BC_date, format="%d-%m-%Y"),"%Y-%m-%d")
BCx$BC_date <- as.Date(BCx$BC_date)
BC <- BCx
rm(BCx)
```

# PFF  BC - Creating Time-Weighted Intervals of Exposures
```{r}
BC <- BC %>% mutate(start=as.IDate(BC_date))
BC <- BC %>% mutate(end=as.IDate(BC_date + months(1) - days(1)))
BC <- as.data.table(BC)
str(BC)
```


```{r}
BC_5yrWtedAvg <- intervalaverage(x=BC,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
BC_5yrWtedAvgx <- BC_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
BC_5yrWtedAvgx <- BC_5yrWtedAvgx %>% rename("BC"="value", "start_5yr"="start", "end_5yr"="end")
BC_5yrWtedAvgx <- BC_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(BC_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, BC_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF OM - Importing OM Datasets
Here I am importing the file which contains monthly OM level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_OM_2021_11_05.xlsx")
OM <- read_excel(outfile1)
```


# PFF OM - Simplifying OM Dataframe
```{r}
OM <- OM %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
OM <- OM %>% 
  pivot_longer(cols=c(2:217), names_to="OM_date", names_prefix="OM_")
```

```{r}
OMx <- OM 
OMx$OM_date <- gsub("jan", "01-01-20", OMx$OM_date)
OMx$OM_date <- gsub("feb", "01-02-20", OMx$OM_date)
OMx$OM_date <- gsub("mar", "01-03-20", OMx$OM_date)
OMx$OM_date <- gsub("apr", "01-04-20", OMx$OM_date)
OMx$OM_date <- gsub("may", "01-05-20", OMx$OM_date)
OMx$OM_date <- gsub("jun", "01-06-20", OMx$OM_date)
OMx$OM_date <- gsub("jul", "01-07-20", OMx$OM_date)
OMx$OM_date <- gsub("aug", "01-08-20", OMx$OM_date)
OMx$OM_date <- gsub("sep", "01-09-20", OMx$OM_date)
OMx$OM_date <- gsub("oct", "01-10-20", OMx$OM_date)
OMx$OM_date <- gsub("nov", "01-11-20", OMx$OM_date)
OMx$OM_date <- gsub("dec", "01-12-20", OMx$OM_date)

OMx$OM_date <- format(as.Date(OMx$OM_date, format="%d-%m-%Y"),"%Y-%m-%d")
OMx$OM_date <- as.Date(OMx$OM_date)
OM <- OMx
rm(OMx)
```

# PFF  OM - Creating Time-Weighted Intervals of Exposures
```{r}
OM <- OM %>% mutate(start=as.IDate(OM_date))
OM <- OM %>% mutate(end=as.IDate(OM_date + months(1) - days(1)))
OM <- as.data.table(OM)
str(OM)
```


```{r}
OM_5yrWtedAvg <- intervalaverage(x=OM,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
OM_5yrWtedAvgx <- OM_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
OM_5yrWtedAvgx <- OM_5yrWtedAvgx %>% rename("OM"="value", "start_5yr"="start", "end_5yr"="end")
OM_5yrWtedAvgx <- OM_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(OM_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, OM_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF SS - Importing SS Datasets
Here I am importing the file which contains monthly SS level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_SS_2021_11_05.xlsx")
SS <- read_excel(outfile1)
```


# PFF SS - Simplifying SS Dataframe
```{r}
SS <- SS %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
SS <- SS %>% 
  pivot_longer(cols=c(2:217), names_to="SS_date", names_prefix="SS_")
```

```{r}
SSx <- SS 
SSx$SS_date <- gsub("jan", "01-01-20", SSx$SS_date)
SSx$SS_date <- gsub("feb", "01-02-20", SSx$SS_date)
SSx$SS_date <- gsub("mar", "01-03-20", SSx$SS_date)
SSx$SS_date <- gsub("apr", "01-04-20", SSx$SS_date)
SSx$SS_date <- gsub("may", "01-05-20", SSx$SS_date)
SSx$SS_date <- gsub("jun", "01-06-20", SSx$SS_date)
SSx$SS_date <- gsub("jul", "01-07-20", SSx$SS_date)
SSx$SS_date <- gsub("aug", "01-08-20", SSx$SS_date)
SSx$SS_date <- gsub("sep", "01-09-20", SSx$SS_date)
SSx$SS_date <- gsub("oct", "01-10-20", SSx$SS_date)
SSx$SS_date <- gsub("nov", "01-11-20", SSx$SS_date)
SSx$SS_date <- gsub("dec", "01-12-20", SSx$SS_date)

SSx$SS_date <- format(as.Date(SSx$SS_date, format="%d-%m-%Y"),"%Y-%m-%d")
SSx$SS_date <- as.Date(SSx$SS_date)
SS <- SSx
rm(SSx)
```

# PFF  SS - Creating Time-Weighted Intervals of Exposures
```{r}
SS <- SS %>% mutate(start=as.IDate(SS_date))
SS <- SS %>% mutate(end=as.IDate(SS_date + months(1) - days(1)))
SS <- as.data.table(SS)
str(SS)
```


```{r}
SS_5yrWtedAvg <- intervalaverage(x=SS,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
SS_5yrWtedAvgx <- SS_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
SS_5yrWtedAvgx <- SS_5yrWtedAvgx %>% rename("SS"="value", "start_5yr"="start", "end_5yr"="end")
SS_5yrWtedAvgx <- SS_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(SS_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, SS_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# PFF Soil - Importing Soil Datasets
Here I am importing the file which contains monthly Soil level estimates by satellite at nearest lon/lat to PFF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("PFF_fILD_2000_2017_Soil_2021_11_05.xlsx")
Soil <- read_excel(outfile1)
```


# PFF Soil - Simplifying Soil Dataframe
```{r}
Soil <- Soil %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
Soil <- Soil %>% 
  pivot_longer(cols=c(2:217), names_to="Soil_date", names_prefix="soil_")
```

```{r}
Soilx <- Soil 
Soilx$Soil_date <- gsub("jan", "01-01-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("feb", "01-02-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("mar", "01-03-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("apr", "01-04-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("may", "01-05-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("jun", "01-06-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("jul", "01-07-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("aug", "01-08-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("sep", "01-09-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("oct", "01-10-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("nov", "01-11-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("dec", "01-12-20", Soilx$Soil_date)

Soilx$Soil_date <- format(as.Date(Soilx$Soil_date, format="%d-%m-%Y"),"%Y-%m-%d")
Soilx$Soil_date <- as.Date(Soilx$Soil_date)
Soil <- Soilx
rm(Soilx)
```

# PFF  Soil - Creating Time-Weighted Intervals of Exposures
```{r}
Soil <- Soil %>% mutate(start=as.IDate(Soil_date))
Soil <- Soil %>% mutate(end=as.IDate(Soil_date + months(1) - days(1)))
Soil <- as.data.table(Soil)
str(Soil)
```


```{r}
Soil_5yrWtedAvg <- intervalaverage(x=Soil,
                y=PFF_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
Soil_5yrWtedAvgx <- Soil_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
Soil_5yrWtedAvgx <- Soil_5yrWtedAvgx %>% rename("Soil"="value", "start_5yr"="start", "end_5yr"="end")
Soil_5yrWtedAvgx <- Soil_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(Soil_5yrWtedAvgx)
```

Join to PFF
```{r}
PFF <- left_join(PFF, Soil_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE-PF - Importing CARE-PF Datasets
Here I am importing the file which contains monthly PM level estimates by satellite at nearest lon/lat to CAREPF patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CAREPF_fILD_2000_2018_PM25_2021_09_16.xlsx")
PM <- read_excel(outfile1)
```

Here I am importing the file which I used for my CIMD work that contains the baseline clinical and demographic data for patients who have CIMD
```{r}
outfile2 <- here("CAREPF_fILDPts_BaselineData_2021_10_22.xlsx")
CARE <- read_excel(outfile2)
```

# CARE-PF - Simplifying PM Dataframe
```{r}
PM <- PM %>% dplyr::select(!c(nrow, dist, lon, lat))
colnames(PM)
```

```{r}
PM <- PM %>% 
  pivot_longer(cols=c(2:228), names_to="PM_date", names_prefix="PM25_")
```

```{r}
PMx <- PM 
PMx$PM_date <- gsub("jan", "01-01-20", PMx$PM_date)
PMx$PM_date <- gsub("feb", "01-02-20", PMx$PM_date)
PMx$PM_date <- gsub("mar", "01-03-20", PMx$PM_date)
PMx$PM_date <- gsub("apr", "01-04-20", PMx$PM_date)
PMx$PM_date <- gsub("may", "01-05-20", PMx$PM_date)
PMx$PM_date <- gsub("jun", "01-06-20", PMx$PM_date)
PMx$PM_date <- gsub("jul", "01-07-20", PMx$PM_date)
PMx$PM_date <- gsub("aug", "01-08-20", PMx$PM_date)
PMx$PM_date <- gsub("sep", "01-09-20", PMx$PM_date)
PMx$PM_date <- gsub("oct", "01-10-20", PMx$PM_date)
PMx$PM_date <- gsub("nov", "01-11-20", PMx$PM_date)
PMx$PM_date <- gsub("dec", "01-12-20", PMx$PM_date)

PMx$PM_date <- format(as.Date(PMx$PM_date, format="%d-%m-%Y"),"%Y-%m-%d")
PMx$PM_date <- as.Date(PMx$PM_date)
PM <- PMx
rm(PMx)
```


# CARE-PF - Simplifying CARE Dataframe
## CARE-PF - Death/Transplant/Censor Date
Extracting year of diagnosis and year of death/transplant/censoring
```{r}
#Start with the year of diagnosis
CARE <- CARE %>% 
  mutate(dx_yrmo = format(as.Date(CARE$dx_date, format="%Y-%m-%d"),"%Y-%m"))
CARE <- CARE %>% 
  mutate(dx_yr = format(as.Date(CARE$dx_date, format="%Y-%m-%d"),"%Y"))
CARE$dx_yr <- as.numeric(CARE$dx_yr)

#Then the year of death or lung transplant
CARE <- CARE %>% 
  mutate(deathORtx_date = if_else(!is.na(tx_date), tx_date, death_date))
CARE <- CARE %>% 
  mutate(deathORtx_yrmo = format(as.Date(CARE$deathORtx_date, format="%Y-%m-%d"),"%Y-%m"))

#Then the year the records were last updated (i.e. year of censoring)
CARE <- CARE %>% 
  mutate(DeathTxCensor_date = if_else(!is.na(deathORtx_date), deathORtx_date, last_updated))
CARE <- CARE %>% 
  mutate(censor_yrmo = format(as.Date(CARE$DeathTxCensor_date, format="%Y-%m-%d"),"%Y-%m"))
```

## CARE-PF - Removing Unnecessary Columns and Correcting Dates
```{r}
CARE <- CARE %>% dplyr::select(c(ID, site, age_dx, sex, smokeHx, dich_smoking, race, dich_Race, avg_s, dx_group, dx, dob, dx_date, death_date, tx_date, DeathTxCensor_date, last_updated, pft_date, fvc_pct, dlco_pct, pft_timefromdx, status, died, txed, deadORtx, time_DeathTxCensor, dx_yr))
CARE <- CARE %>% 
  mutate_at(c("dob","death_date", "last_updated", "tx_date", "dx_date", "pft_date", "DeathTxCensor_date"), as.Date)
str(CARE)
```

## CARE-PF - Correcting Smoking
Need to correct smoking variables
```{r}
CARE$smokeHx <- as.character(CARE$smokeHx) 
CARE <- CARE %>% mutate(smokeHx1=if_else(is.na(smokeHx), "Unknown", smokeHx))

#now need to make new dich_smoking category
CARE$dich_smoking <- as.character(CARE$dich_smoking) 
CARE <- CARE %>% mutate(dich_smoking1=if_else(is.na(dich_smoking),"Unknown", dich_smoking))
```

Now need to remove old smoking variables and rename new ones
```{r}
CARE <- CARE %>% dplyr::select(-c(smokeHx, dich_smoking))
CARE <- CARE %>% rename(c("smokeHx"="smokeHx1", "dich_smoking"="dich_smoking1"))
CARE$smokeHx <- as.factor(CARE$smokeHx)
CARE$dich_smoking <- as.factor(CARE$dich_smoking)
CARE$smokeHx <- fct_relevel(CARE$smokeHx, c("Never","Former","Always","Unknown"))
CARE$dich_smoking <- fct_relevel(CARE$dich_smoking, c("Never","Ever","Unknown"))
```

## CARE-PF - Correcting Factors
Need to correct other factor variables
```{r}
CARE$sex <- fct_relevel(CARE$sex, c("M","F"))
CARE$race <- fct_relevel(CARE$race, c("W","B","A","N","U"))
CARE$dich_Race <- fct_relevel(CARE$dich_Race, c("White","Non-White"))
CARE$dx <- fct_relevel(CARE$dx, c("IPF"))
CARE$dx_group <- fct_relevel(CARE$dx_group, c("IPF"))
CARE <- CARE %>% mutate_at(c("status","died", "txed", "deadORtx", "site"), as.factor)
```

## CARE-PF - Creating New Variables
### CARE-PF - IPF vs Other Diagnosis
```{r}
CARE <- CARE %>% mutate(dx_IPF=ifelse(dx=="IPF", "IPF", "not_IPF"))  
CARE$dx_IPF <- fct_relevel(CARE$dx_IPF, c("IPF"))
```

### CARE-PF - Disadvantage Distribution
Creating this empirical cumulative distribution will allow us to combine the analyses of all three cohorts even though the measurements for disadvantage are different between the three.
```{r}
plot(ecdf(CARE$avg_s))
CARE$disadv <- ecdf(CARE$avg_s)(CARE$avg_s)
```

# CARE-PF - Modifying CARE Dataset
Take down CARE dataset to the 3389 patients with complete data
```{r}
IDs <- as.data.table(unique(PM$ID))
IDs <- IDs %>% rename("ID"="V1")
CARE <- left_join(IDs, CARE, by="ID")
```


```{r}
CARE <- CARE %>% mutate(days_DeathTxCensor=(time_DeathTxCensor*365.25))
```
Longest time_DeathTxCensor= 9546days

30-day longest time interval would be 9570 days
```{r}
start <- seq(1, 9541, by = 30)
start
end <- seq(30, 9570, by = 30)
end
```

Repeat the list of intervals 3389 times (number of patients in CARE)
```{r}
start <- rep(start, times=3389)
end <- rep(end, times=3389)
intervals <- as.data.frame(cbind(start, end))
```

Add ID column to intervals
```{r}
IDs <- rep(CARE$ID, each=319)
intervals <- as.data.frame(cbind(IDs, intervals))
intervals <- intervals %>% rename("ID"="IDs")
```

Join CARE and intervals
```{r}
CARE <- left_join(intervals, CARE, by="ID")
```

Determine if event occurred during interval
```{r}
CARE <- CARE %>% mutate(event=if_else((days_DeathTxCensor>=start & days_DeathTxCensor<=end), 1, 0))
```

Now will add date intervals for 5yr start and end times)
```{r}
CARE <- CARE %>% mutate(end_5yr=(dx_date + days(end)))
CARE <- CARE %>% mutate(start_5yr=(end_5yr - days(1826)))
```

Now need to remove any rows where end_5yr is > date_DeathTxCensor (Amanda indicated need to remove rows where start_5yr > date_DeathTxCensor, but I don't think this is correct because then we'd be assigning exposures to patients where they were alive/not transplanted for <5yrs for that exposure - need to double check with her)
```{r}
CARE <- CARE %>% filter(!(end_5yr>DeathTxCensor_date & event!=1))
```



# CARE-PF - Creating Time-Weighted Intervals of Exposures
```{r}
PM <- PM %>% mutate(start=as.IDate(PM_date))
PM <- PM %>% mutate(end=as.IDate(PM_date + months(1) - days(1)))
PM <- as.data.table(PM)
str(PM)
```

Creating a list of intervals we want to calculate exposures for:
```{r}
CARE_intervals <- CARE %>% dplyr::select(ID, start_5yr, end_5yr)
CARE_intervals <- CARE_intervals %>% mutate_at(c("start_5yr", "end_5yr"), as.IDate)
CARE_intervals <- CARE_intervals %>% rename(c("start"="start_5yr", "end"="end_5yr"))
CARE_intervals <- as.data.table(CARE_intervals)
str(CARE_intervals)
```

```{r}
PM_5yrWtedAvg <- intervalaverage(x=PM,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
PM_5yrWtedAvgx <- PM_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
PM_5yrWtedAvgx <- PM_5yrWtedAvgx %>% rename("PM"="value", "start_5yr"="start", "end_5yr"="end")
PM_5yrWtedAvgx <- PM_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(PM_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, PM_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```




# CARE SO4 - Importing SO4 Datasets
Here I am importing the file which contains monthly SO4 level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_SO4_2021_11_05.xlsx")
SO4 <- read_excel(outfile1)
```


# CARE SO4 - Simplifying SO4 Dataframe
```{r}
SO4 <- SO4 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
SO4 <- SO4 %>% 
  pivot_longer(cols=c(2:217), names_to="SO4_date", names_prefix="SO4_")
```

```{r}
SO4x <- SO4 
SO4x$SO4_date <- gsub("jan", "01-01-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("feb", "01-02-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("mar", "01-03-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("apr", "01-04-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("may", "01-05-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("jun", "01-06-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("jul", "01-07-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("aug", "01-08-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("sep", "01-09-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("oct", "01-10-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("nov", "01-11-20", SO4x$SO4_date)
SO4x$SO4_date <- gsub("dec", "01-12-20", SO4x$SO4_date)

SO4x$SO4_date <- format(as.Date(SO4x$SO4_date, format="%d-%m-%Y"),"%Y-%m-%d")
SO4x$SO4_date <- as.Date(SO4x$SO4_date)
SO4 <- SO4x
rm(SO4x)
```

# CARE  SO4 - Creating Time-Weighted Intervals of Exposures
```{r}
SO4 <- SO4 %>% mutate(start=as.IDate(SO4_date))
SO4 <- SO4 %>% mutate(end=as.IDate(SO4_date + months(1) - days(1)))
SO4 <- as.data.table(SO4)
str(SO4)
```


```{r}
SO4_5yrWtedAvg <- intervalaverage(x=SO4,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
SO4_5yrWtedAvgx <- SO4_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
SO4_5yrWtedAvgx <- SO4_5yrWtedAvgx %>% rename("SO4"="value", "start_5yr"="start", "end_5yr"="end")
SO4_5yrWtedAvgx <- SO4_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(SO4_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, SO4_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE NO3 - Importing NO3 Datasets
Here I am importing the file which contains monthly NO3 level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_NO3_2021_11_05.xlsx")
NO3 <- read_excel(outfile1)
```


# CARE NO3 - Simplifying NO3 Dataframe
```{r}
NO3 <- NO3 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
NO3 <- NO3 %>% 
  pivot_longer(cols=c(2:217), names_to="NO3_date", names_prefix="NIT_")
```

```{r}
NO3x <- NO3 
NO3x$NO3_date <- gsub("jan", "01-01-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("feb", "01-02-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("mar", "01-03-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("apr", "01-04-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("may", "01-05-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("jun", "01-06-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("jul", "01-07-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("aug", "01-08-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("sep", "01-09-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("oct", "01-10-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("nov", "01-11-20", NO3x$NO3_date)
NO3x$NO3_date <- gsub("dec", "01-12-20", NO3x$NO3_date)

NO3x$NO3_date <- format(as.Date(NO3x$NO3_date, format="%d-%m-%Y"),"%Y-%m-%d")
NO3x$NO3_date <- as.Date(NO3x$NO3_date)
NO3 <- NO3x
rm(NO3x)
```

# CARE  NO3 - Creating Time-Weighted Intervals of Exposures
```{r}
NO3 <- NO3 %>% mutate(start=as.IDate(NO3_date))
NO3 <- NO3 %>% mutate(end=as.IDate(NO3_date + months(1) - days(1)))
NO3 <- as.data.table(NO3)
str(NO3)
```


```{r}
NO3_5yrWtedAvg <- intervalaverage(x=NO3,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
NO3_5yrWtedAvgx <- NO3_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
NO3_5yrWtedAvgx <- NO3_5yrWtedAvgx %>% rename("NO3"="value", "start_5yr"="start", "end_5yr"="end")
NO3_5yrWtedAvgx <- NO3_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(NO3_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, NO3_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE NH4 - Importing NH4 Datasets
Here I am importing the file which contains monthly NH4 level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_NH4_2021_11_05.xlsx")
NH4 <- read_excel(outfile1)
```


# CARE NH4 - Simplifying NH4 Dataframe
```{r}
NH4 <- NH4 %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
NH4 <- NH4 %>% 
  pivot_longer(cols=c(2:217), names_to="NH4_date", names_prefix="NH4_")
```

```{r}
NH4x <- NH4 
NH4x$NH4_date <- gsub("jan", "01-01-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("feb", "01-02-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("mar", "01-03-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("apr", "01-04-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("may", "01-05-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("jun", "01-06-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("jul", "01-07-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("aug", "01-08-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("sep", "01-09-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("oct", "01-10-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("nov", "01-11-20", NH4x$NH4_date)
NH4x$NH4_date <- gsub("dec", "01-12-20", NH4x$NH4_date)

NH4x$NH4_date <- format(as.Date(NH4x$NH4_date, format="%d-%m-%Y"),"%Y-%m-%d")
NH4x$NH4_date <- as.Date(NH4x$NH4_date)
NH4 <- NH4x
rm(NH4x)
```

# CARE  NH4 - Creating Time-Weighted Intervals of Exposures
```{r}
NH4 <- NH4 %>% mutate(start=as.IDate(NH4_date))
NH4 <- NH4 %>% mutate(end=as.IDate(NH4_date + months(1) - days(1)))
NH4 <- as.data.table(NH4)
str(NH4)
```


```{r}
NH4_5yrWtedAvg <- intervalaverage(x=NH4,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
NH4_5yrWtedAvgx <- NH4_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
NH4_5yrWtedAvgx <- NH4_5yrWtedAvgx %>% rename("NH4"="value", "start_5yr"="start", "end_5yr"="end")
NH4_5yrWtedAvgx <- NH4_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(NH4_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, NH4_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE BC - Importing BC Datasets
Here I am importing the file which contains monthly BC level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_BC_2021_11_05.xlsx")
BC <- read_excel(outfile1)
```


# CARE BC - Simplifying BC Dataframe
```{r}
BC <- BC %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
BC <- BC %>% 
  pivot_longer(cols=c(2:217), names_to="BC_date", names_prefix="BC_")
```

```{r}
BCx <- BC 
BCx$BC_date <- gsub("jan", "01-01-20", BCx$BC_date)
BCx$BC_date <- gsub("feb", "01-02-20", BCx$BC_date)
BCx$BC_date <- gsub("mar", "01-03-20", BCx$BC_date)
BCx$BC_date <- gsub("apr", "01-04-20", BCx$BC_date)
BCx$BC_date <- gsub("may", "01-05-20", BCx$BC_date)
BCx$BC_date <- gsub("jun", "01-06-20", BCx$BC_date)
BCx$BC_date <- gsub("jul", "01-07-20", BCx$BC_date)
BCx$BC_date <- gsub("aug", "01-08-20", BCx$BC_date)
BCx$BC_date <- gsub("sep", "01-09-20", BCx$BC_date)
BCx$BC_date <- gsub("oct", "01-10-20", BCx$BC_date)
BCx$BC_date <- gsub("nov", "01-11-20", BCx$BC_date)
BCx$BC_date <- gsub("dec", "01-12-20", BCx$BC_date)

BCx$BC_date <- format(as.Date(BCx$BC_date, format="%d-%m-%Y"),"%Y-%m-%d")
BCx$BC_date <- as.Date(BCx$BC_date)
BC <- BCx
rm(BCx)
```

# CARE  BC - Creating Time-Weighted Intervals of Exposures
```{r}
BC <- BC %>% mutate(start=as.IDate(BC_date))
BC <- BC %>% mutate(end=as.IDate(BC_date + months(1) - days(1)))
BC <- as.data.table(BC)
str(BC)
```


```{r}
BC_5yrWtedAvg <- intervalaverage(x=BC,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
BC_5yrWtedAvgx <- BC_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
BC_5yrWtedAvgx <- BC_5yrWtedAvgx %>% rename("BC"="value", "start_5yr"="start", "end_5yr"="end")
BC_5yrWtedAvgx <- BC_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(BC_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, BC_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE OM - Importing OM Datasets
Here I am importing the file which contains monthly OM level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_OM_2021_11_05.xlsx")
OM <- read_excel(outfile1)
```


# CARE OM - Simplifying OM Dataframe
```{r}
OM <- OM %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
OM <- OM %>% 
  pivot_longer(cols=c(2:217), names_to="OM_date", names_prefix="OM_")
```

```{r}
OMx <- OM 
OMx$OM_date <- gsub("jan", "01-01-20", OMx$OM_date)
OMx$OM_date <- gsub("feb", "01-02-20", OMx$OM_date)
OMx$OM_date <- gsub("mar", "01-03-20", OMx$OM_date)
OMx$OM_date <- gsub("apr", "01-04-20", OMx$OM_date)
OMx$OM_date <- gsub("may", "01-05-20", OMx$OM_date)
OMx$OM_date <- gsub("jun", "01-06-20", OMx$OM_date)
OMx$OM_date <- gsub("jul", "01-07-20", OMx$OM_date)
OMx$OM_date <- gsub("aug", "01-08-20", OMx$OM_date)
OMx$OM_date <- gsub("sep", "01-09-20", OMx$OM_date)
OMx$OM_date <- gsub("oct", "01-10-20", OMx$OM_date)
OMx$OM_date <- gsub("nov", "01-11-20", OMx$OM_date)
OMx$OM_date <- gsub("dec", "01-12-20", OMx$OM_date)

OMx$OM_date <- format(as.Date(OMx$OM_date, format="%d-%m-%Y"),"%Y-%m-%d")
OMx$OM_date <- as.Date(OMx$OM_date)
OM <- OMx
rm(OMx)
```

# CARE  OM - Creating Time-Weighted Intervals of Exposures
```{r}
OM <- OM %>% mutate(start=as.IDate(OM_date))
OM <- OM %>% mutate(end=as.IDate(OM_date + months(1) - days(1)))
OM <- as.data.table(OM)
str(OM)
```


```{r}
OM_5yrWtedAvg <- intervalaverage(x=OM,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
OM_5yrWtedAvgx <- OM_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
OM_5yrWtedAvgx <- OM_5yrWtedAvgx %>% rename("OM"="value", "start_5yr"="start", "end_5yr"="end")
OM_5yrWtedAvgx <- OM_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(OM_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, OM_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE SS - Importing SS Datasets
Here I am importing the file which contains monthly SS level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_SS_2021_11_05.xlsx")
SS <- read_excel(outfile1)
```


# CARE SS - Simplifying SS Dataframe
```{r}
SS <- SS %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
SS <- SS %>% 
  pivot_longer(cols=c(2:217), names_to="SS_date", names_prefix="SS_")
```

```{r}
SSx <- SS 
SSx$SS_date <- gsub("jan", "01-01-20", SSx$SS_date)
SSx$SS_date <- gsub("feb", "01-02-20", SSx$SS_date)
SSx$SS_date <- gsub("mar", "01-03-20", SSx$SS_date)
SSx$SS_date <- gsub("apr", "01-04-20", SSx$SS_date)
SSx$SS_date <- gsub("may", "01-05-20", SSx$SS_date)
SSx$SS_date <- gsub("jun", "01-06-20", SSx$SS_date)
SSx$SS_date <- gsub("jul", "01-07-20", SSx$SS_date)
SSx$SS_date <- gsub("aug", "01-08-20", SSx$SS_date)
SSx$SS_date <- gsub("sep", "01-09-20", SSx$SS_date)
SSx$SS_date <- gsub("oct", "01-10-20", SSx$SS_date)
SSx$SS_date <- gsub("nov", "01-11-20", SSx$SS_date)
SSx$SS_date <- gsub("dec", "01-12-20", SSx$SS_date)

SSx$SS_date <- format(as.Date(SSx$SS_date, format="%d-%m-%Y"),"%Y-%m-%d")
SSx$SS_date <- as.Date(SSx$SS_date)
SS <- SSx
rm(SSx)
```

# CARE  SS - Creating Time-Weighted Intervals of Exposures
```{r}
SS <- SS %>% mutate(start=as.IDate(SS_date))
SS <- SS %>% mutate(end=as.IDate(SS_date + months(1) - days(1)))
SS <- as.data.table(SS)
str(SS)
```


```{r}
SS_5yrWtedAvg <- intervalaverage(x=SS,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
SS_5yrWtedAvgx <- SS_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
SS_5yrWtedAvgx <- SS_5yrWtedAvgx %>% rename("SS"="value", "start_5yr"="start", "end_5yr"="end")
SS_5yrWtedAvgx <- SS_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(SS_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, SS_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```



# CARE Soil - Importing Soil Datasets
Here I am importing the file which contains monthly Soil level estimates by satellite at nearest lon/lat to CARE patient residential addresses. These are linked to the patient ID.
```{r}
outfile1 <- here("CARE_fILD_2000_2017_Soil_2021_11_05.xlsx")
Soil <- read_excel(outfile1)
```


# CARE Soil - Simplifying Soil Dataframe
```{r}
Soil <- Soil %>% dplyr::select(!c(nrow, dist, lon, lat))
```


```{r}
Soil <- Soil %>% 
  pivot_longer(cols=c(2:217), names_to="Soil_date", names_prefix="soil_")
```

```{r}
Soilx <- Soil 
Soilx$Soil_date <- gsub("jan", "01-01-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("feb", "01-02-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("mar", "01-03-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("apr", "01-04-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("may", "01-05-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("jun", "01-06-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("jul", "01-07-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("aug", "01-08-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("sep", "01-09-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("oct", "01-10-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("nov", "01-11-20", Soilx$Soil_date)
Soilx$Soil_date <- gsub("dec", "01-12-20", Soilx$Soil_date)

Soilx$Soil_date <- format(as.Date(Soilx$Soil_date, format="%d-%m-%Y"),"%Y-%m-%d")
Soilx$Soil_date <- as.Date(Soilx$Soil_date)
Soil <- Soilx
rm(Soilx)
```

# CARE  Soil - Creating Time-Weighted Intervals of Exposures
```{r}
Soil <- Soil %>% mutate(start=as.IDate(Soil_date))
Soil <- Soil %>% mutate(end=as.IDate(Soil_date + months(1) - days(1)))
Soil <- as.data.table(Soil)
str(Soil)
```


```{r}
Soil_5yrWtedAvg <- intervalaverage(x=Soil,
                y=CARE_intervals,
                interval_vars=c("start","end"),
                value_vars=c("value"),
                group_vars="ID",
                required_percentage = 0.01)
```
So this produces a row for each interval for each patient

Select only the necessary columns, but will keep the original dataframe to interrogate data missingess if needed
```{r}
Soil_5yrWtedAvgx <- Soil_5yrWtedAvg %>% dplyr::select(ID, value, start, end)
Soil_5yrWtedAvgx <- Soil_5yrWtedAvgx %>% rename("Soil"="value", "start_5yr"="start", "end_5yr"="end")
Soil_5yrWtedAvgx <- Soil_5yrWtedAvgx %>% mutate_at(c("start_5yr", "end_5yr"), as.Date)
str(Soil_5yrWtedAvgx)
```

Join to CARE
```{r}
CARE <- left_join(CARE, Soil_5yrWtedAvgx, by=c("ID", "start_5yr", "end_5yr"))
```







# Remove unnecessary dataframes
```{r}
rm(CARE_intervals, intervals, PFF_intervals, PM, PM_5yrWtedAvg, PM_5yrWtedAvgx, PM25, Simm_intervals, end, start, IDs, SO4, SO4_5yrWtedAvg, SO4_5yrWtedAvgx, NO3, NO3_5yrWtedAvg, NO3_5yrWtedAvgx, NH4, NH4_5yrWtedAvg, NH4_5yrWtedAvgx, BC, BC_5yrWtedAvg, BC_5yrWtedAvgx, OM, OM_5yrWtedAvg, OM_5yrWtedAvgx, SS, SS_5yrWtedAvg, SS_5yrWtedAvgx, Soil, Soil_5yrWtedAvg, Soil_5yrWtedAvgx)
```



# Combine all into one dataframe
```{r}
colnames(Simm)
colnames(PFF)
colnames(CARE)
```

```{r}
Simm <- Simm %>% mutate(site=1)
Simm <- Simm %>% mutate(dlco_date=pft_date)
Simm <- Simm %>% rename(c("fvc_date"="pft_date"))
Simm <- Simm %>% dplyr::select(ID, start, end, site, age_dx, sex, race, dich_Race, smokeHx, dx_IPF, disadv, dx_group, dx, dx_yr, dx_date, death_date, tx_date, DeathTxCensor_date, last_updated, fvc_date, dlco_date, fvc_pct, dlco_pct, status, deadORtx, time_DeathTxCensor, days_DeathTxCensor, event, start_5yr, end_5yr, PM, SO4, NO3, NH4, BC, OM, SS, Soil)
```

```{r}
PFF <- PFF %>% rename(c("last_updated"="censor_date"))
PFF <- PFF %>% dplyr::select(ID, start, end, site, age_dx, sex, race, dich_Race, smokeHx, dx_IPF, disadv, dx_group, dx, dx_yr, dx_date, death_date, tx_date, DeathTxCensor_date, last_updated, fvc_date, dlco_date, fvc_pct, dlco_pct, status, deadORtx, time_DeathTxCensor, days_DeathTxCensor, event, start_5yr, end_5yr, PM, SO4, NO3, NH4, BC, OM, SS, Soil)
```

```{r}
CARE <- CARE %>% mutate(dlco_date=pft_date)
CARE <- CARE %>% rename(c("fvc_date"="pft_date"))
CARE <- CARE %>% dplyr::select(ID, start, end, site, age_dx, sex, race, dich_Race, smokeHx, dx_IPF, disadv, dx_group, dx, dx_yr, dx_date, death_date, tx_date, DeathTxCensor_date, last_updated, fvc_date, dlco_date, fvc_pct, dlco_pct, status, deadORtx, time_DeathTxCensor, days_DeathTxCensor, event, start_5yr, end_5yr, PM, SO4, NO3, NH4, BC, OM, SS, Soil)
```

# Combining Cohorts
```{r}
colnames(Simm)==colnames(PFF)
colnames(PFF)==colnames(CARE)
```

## Creating Cohort Column
```{r}
Simm <- Simm %>% mutate(cohort="Simmons")
PFF <- PFF %>% mutate(cohort="PFF")
CARE <- CARE %>% mutate(cohort="CARE-PF")
```

## Fixing Columns in PFF
Fixing sex
```{r}
PFF <- PFF %>% mutate(sex1=if_else(sex=="Male", "M", "F"))
PFF <- PFF %>% dplyr::select(!sex)
PFF <- PFF %>% rename(c("sex"="sex1"))
PFF <- PFF %>% dplyr::select(ID, start, end, site, age_dx, sex, race, dich_Race, smokeHx, dx_IPF, disadv, dx_group, dx, dx_yr, dx_date, death_date, tx_date, DeathTxCensor_date, last_updated, fvc_date, dlco_date, fvc_pct, dlco_pct, status, deadORtx, time_DeathTxCensor, days_DeathTxCensor, event, start_5yr, end_5yr, PM, SO4, NO3, NH4, BC, OM, SS, Soil, cohort)
```

Fixing ID - some of the IDs are shared between PFF and Simm
```{r}
#First want to check how many IDs are shared between Simm and PFF, Simm and CARE, and PFF and CARE
intersect(Simm$ID, PFF$ID)
intersect(Simm$ID, CARE$ID)
intersect(CARE$ID, PFF$ID)

PFF$ID <- paste0(2000, PFF$ID)
intersect(Simm$ID, PFF$ID)
```
No overlaps between Simm/CARE or PFF/CARE, but two with Simm/PFF, so add "2000" to front of PFF IDs


## Joining rows
```{r}
All <- rbind(Simm, PFF)
All <- rbind(All, CARE)
str(All)
```

## Correct Site and Cohort to Factors
```{r}
All$cohort <- as.factor(All$cohort)
All$site <- as.factor(All$site)
All$event <- as.factor(All$event)
```


# Export File with All PM2.5 and Constituent Time Frames Matched
```{r}
write_xlsx(All, path="CombinedCohorts_fILD_AllConstituentsMatched_2023_01_02.xlsx")
```


# Summary Data
## Summary of Time-Varying PM2.5 and Constituent Levels
### Simmons
```{r}
Simm_medPM <- Simm %>% group_by(ID) %>% summarise(Mean=mean(PM, na.rm=T), Max=max(PM, na.rm=T), Min=min(PM, na.rm=T), Median=median(PM, na.rm=T), StdDev=sd(PM, na.rm=T), Q1=quantile(PM, 0.25, na.rm=T), Q3=quantile(PM, 0.75, na.rm=T))
Simm_medPM %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medSO4 <- Simm %>% group_by(ID) %>% summarise(Mean=mean(SO4, na.rm=T), Max=max(SO4, na.rm=T), Min=min(SO4, na.rm=T), Median=median(SO4, na.rm=T), StdDev=sd(SO4, na.rm=T), Q1=quantile(SO4, 0.25, na.rm=T), Q3=quantile(SO4, 0.75, na.rm=T))
Simm_medSO4 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medNO3 <- Simm %>% group_by(ID) %>% summarise(Mean=mean(NO3, na.rm=T), Max=max(NO3, na.rm=T), Min=min(NO3, na.rm=T), Median=median(NO3, na.rm=T), StdDev=sd(NO3, na.rm=T), Q1=quantile(NO3, 0.25, na.rm=T), Q3=quantile(NO3, 0.75, na.rm=T))
Simm_medNO3 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medNH4 <- Simm %>% group_by(ID) %>% summarise(Mean=mean(NH4, na.rm=T), Max=max(NH4, na.rm=T), Min=min(NH4, na.rm=T), Median=median(NH4, na.rm=T), StdDev=sd(NH4, na.rm=T), Q1=quantile(NH4, 0.25, na.rm=T), Q3=quantile(NH4, 0.75, na.rm=T))
Simm_medNH4 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medBC <- Simm %>% group_by(ID) %>% summarise(Mean=mean(BC, na.rm=T), Max=max(BC, na.rm=T), Min=min(BC, na.rm=T), Median=median(BC, na.rm=T), StdDev=sd(BC, na.rm=T), Q1=quantile(BC, 0.25, na.rm=T), Q3=quantile(BC, 0.75, na.rm=T))
Simm_medBC %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medOM <- Simm %>% group_by(ID) %>% summarise(Mean=mean(OM, na.rm=T), Max=max(OM, na.rm=T), Min=min(OM, na.rm=T), Median=median(OM, na.rm=T), StdDev=sd(OM, na.rm=T), Q1=quantile(OM, 0.25, na.rm=T), Q3=quantile(OM, 0.75, na.rm=T))
Simm_medOM %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medSS <- Simm %>% group_by(ID) %>% summarise(Mean=mean(SS, na.rm=T), Max=max(SS, na.rm=T), Min=min(SS, na.rm=T), Median=median(SS, na.rm=T), StdDev=sd(SS, na.rm=T), Q1=quantile(SS, 0.25, na.rm=T), Q3=quantile(SS, 0.75, na.rm=T))
Simm_medSS %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
Simm_medSoil <- Simm %>% group_by(ID) %>% summarise(Mean=mean(Soil, na.rm=T), Max=max(Soil, na.rm=T), Min=min(Soil, na.rm=T), Median=median(Soil, na.rm=T), StdDev=sd(Soil, na.rm=T), Q1=quantile(Soil, 0.25, na.rm=T), Q3=quantile(Soil, 0.75, na.rm=T))
Simm_medSoil %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

### PFF
```{r}
PFF_medPM <- PFF %>% group_by(ID) %>% summarise(Mean=mean(PM, na.rm=T), Max=max(PM, na.rm=T), Min=min(PM, na.rm=T), Median=median(PM, na.rm=T), StdDev=sd(PM, na.rm=T), Q1=quantile(PM, 0.25, na.rm=T), Q3=quantile(PM, 0.75, na.rm=T))
PFF_medPM %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medPM <- inner_join(PFF_medPM, PFF, by="ID")
PFF_medPM %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medSO4 <- PFF %>% group_by(ID) %>% summarise(Mean=mean(SO4, na.rm=T), Max=max(SO4, na.rm=T), Min=min(SO4, na.rm=T), Median=median(SO4, na.rm=T), StdDev=sd(SO4, na.rm=T), Q1=quantile(SO4, 0.25, na.rm=T), Q3=quantile(SO4, 0.75, na.rm=T))
PFF_medSO4 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medSO4 <- inner_join(PFF_medSO4, PFF, by="ID")
PFF_medSO4 %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medNO3 <- PFF %>% group_by(ID) %>% summarise(Mean=mean(NO3, na.rm=T), Max=max(NO3, na.rm=T), Min=min(NO3, na.rm=T), Median=median(NO3, na.rm=T), StdDev=sd(NO3, na.rm=T), Q1=quantile(NO3, 0.25, na.rm=T), Q3=quantile(NO3, 0.75, na.rm=T))
PFF_medNO3 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medNO3 <- inner_join(PFF_medNO3, PFF, by="ID")
PFF_medNO3 %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medNH4 <- PFF %>% group_by(ID) %>% summarise(Mean=mean(NH4, na.rm=T), Max=max(NH4, na.rm=T), Min=min(NH4, na.rm=T), Median=median(NH4, na.rm=T), StdDev=sd(NH4, na.rm=T), Q1=quantile(NH4, 0.25, na.rm=T), Q3=quantile(NH4, 0.75, na.rm=T))
PFF_medNH4 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medNH4 <- inner_join(PFF_medNH4, PFF, by="ID")
PFF_medNH4 %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medBC <- PFF %>% group_by(ID) %>% summarise(Mean=mean(BC, na.rm=T), Max=max(BC, na.rm=T), Min=min(BC, na.rm=T), Median=median(BC, na.rm=T), StdDev=sd(BC, na.rm=T), Q1=quantile(BC, 0.25, na.rm=T), Q3=quantile(BC, 0.75, na.rm=T))
PFF_medBC %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medBC <- inner_join(PFF_medBC, PFF, by="ID")
PFF_medBC %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medOM <- PFF %>% group_by(ID) %>% summarise(Mean=mean(OM, na.rm=T), Max=max(OM, na.rm=T), Min=min(OM, na.rm=T), Median=median(OM, na.rm=T), StdDev=sd(OM, na.rm=T), Q1=quantile(OM, 0.25, na.rm=T), Q3=quantile(OM, 0.75, na.rm=T))
PFF_medOM %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medOM <- inner_join(PFF_medOM, PFF, by="ID")
PFF_medOM %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medSS <- PFF %>% group_by(ID) %>% summarise(Mean=mean(SS, na.rm=T), Max=max(SS, na.rm=T), Min=min(SS, na.rm=T), Median=median(SS, na.rm=T), StdDev=sd(SS, na.rm=T), Q1=quantile(SS, 0.25, na.rm=T), Q3=quantile(SS, 0.75, na.rm=T))
PFF_medSS %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medSS <- inner_join(PFF_medSS, PFF, by="ID")
PFF_medSS %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
PFF_medSoil <- PFF %>% group_by(ID) %>% summarise(Mean=mean(Soil, na.rm=T), Max=max(Soil, na.rm=T), Min=min(Soil, na.rm=T), Median=median(Soil, na.rm=T), StdDev=sd(Soil, na.rm=T), Q1=quantile(Soil, 0.25, na.rm=T), Q3=quantile(Soil, 0.75, na.rm=T))
PFF_medSoil %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
PFF_medSoil <- inner_join(PFF_medSoil, PFF, by="ID")
PFF_medSoil %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```


### CARE-PF
```{r}
CARE_medPM <- CARE %>% group_by(ID) %>% summarise(Mean=mean(PM, na.rm=T), Max=max(PM, na.rm=T), Min=min(PM, na.rm=T), Median=median(PM, na.rm=T), StdDev=sd(PM, na.rm=T), Q1=quantile(PM, 0.25, na.rm=T), Q3=quantile(PM, 0.75, na.rm=T))
CARE_medPM %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medPM <- inner_join(CARE_medPM, CARE, by="ID")
CARE_medPM %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medSO4 <- CARE %>% group_by(ID) %>% summarise(Mean=mean(SO4, na.rm=T), Max=max(SO4, na.rm=T), Min=min(SO4, na.rm=T), Median=median(SO4, na.rm=T), StdDev=sd(SO4, na.rm=T), Q1=quantile(SO4, 0.25, na.rm=T), Q3=quantile(SO4, 0.75, na.rm=T))
CARE_medSO4 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medSO4 <- inner_join(CARE_medSO4, CARE, by="ID")
CARE_medSO4 %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medNO3 <- CARE %>% group_by(ID) %>% summarise(Mean=mean(NO3, na.rm=T), Max=max(NO3, na.rm=T), Min=min(NO3, na.rm=T), Median=median(NO3, na.rm=T), StdDev=sd(NO3, na.rm=T), Q1=quantile(NO3, 0.25, na.rm=T), Q3=quantile(NO3, 0.75, na.rm=T))
CARE_medNO3 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medNO3 <- inner_join(CARE_medNO3, CARE, by="ID")
CARE_medNO3 %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medNH4 <- CARE %>% group_by(ID) %>% summarise(Mean=mean(NH4, na.rm=T), Max=max(NH4, na.rm=T), Min=min(NH4, na.rm=T), Median=median(NH4, na.rm=T), StdDev=sd(NH4, na.rm=T), Q1=quantile(NH4, 0.25, na.rm=T), Q3=quantile(NH4, 0.75, na.rm=T))
CARE_medNH4 %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medNH4 <- inner_join(CARE_medNH4, CARE, by="ID")
CARE_medNH4 %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medBC <- CARE %>% group_by(ID) %>% summarise(Mean=mean(BC, na.rm=T), Max=max(BC, na.rm=T), Min=min(BC, na.rm=T), Median=median(BC, na.rm=T), StdDev=sd(BC, na.rm=T), Q1=quantile(BC, 0.25, na.rm=T), Q3=quantile(BC, 0.75, na.rm=T))
CARE_medBC %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medBC <- inner_join(CARE_medBC, CARE, by="ID")
CARE_medBC %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medOM <- CARE %>% group_by(ID) %>% summarise(Mean=mean(OM, na.rm=T), Max=max(OM, na.rm=T), Min=min(OM, na.rm=T), Median=median(OM, na.rm=T), StdDev=sd(OM, na.rm=T), Q1=quantile(OM, 0.25, na.rm=T), Q3=quantile(OM, 0.75, na.rm=T))
CARE_medOM %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medOM <- inner_join(CARE_medOM, CARE, by="ID")
CARE_medOM %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medSS <- CARE %>% group_by(ID) %>% summarise(Mean=mean(SS, na.rm=T), Max=max(SS, na.rm=T), Min=min(SS, na.rm=T), Median=median(SS, na.rm=T), StdDev=sd(SS, na.rm=T), Q1=quantile(SS, 0.25, na.rm=T), Q3=quantile(SS, 0.75, na.rm=T))
CARE_medSS %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medSS <- inner_join(CARE_medSS, CARE, by="ID")
CARE_medSS %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

```{r}
CARE_medSoil <- CARE %>% group_by(ID) %>% summarise(Mean=mean(Soil, na.rm=T), Max=max(Soil, na.rm=T), Min=min(Soil, na.rm=T), Median=median(Soil, na.rm=T), StdDev=sd(Soil, na.rm=T), Q1=quantile(Soil, 0.25, na.rm=T), Q3=quantile(Soil, 0.75, na.rm=T))
CARE_medSoil %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
CARE_medSoil <- inner_join(CARE_medSoil, CARE, by="ID")
CARE_medSoil %>% group_by(site) %>% summarise(Mean=mean(Mean, na.rm=T), Max=max(Max, na.rm=T), Min=min(Min, na.rm=T), Median=median(Median, na.rm=T), StdDev=sd(StdDev, na.rm=T), Q1=quantile(Q1, 0.25, na.rm=T), Q3=quantile(Q3, 0.75, na.rm=T))
```

### Create summarized time-varying exposures excel file
```{r}
Simm_medPM <- Simm_medPM %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medSO4 <- Simm_medSO4 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medNO3 <- Simm_medNO3 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medNH4 <- Simm_medNH4 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medBC <- Simm_medBC %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medOM <- Simm_medOM %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medSS <- Simm_medSS %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
Simm_medSoil <- Simm_medSoil %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)

PFF_medPM <- PFF_medPM %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medSO4 <- PFF_medSO4 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medNO3 <- PFF_medNO3 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medNH4 <- PFF_medNH4 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medBC <- PFF_medBC %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medOM <- PFF_medOM %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medSS <- PFF_medSS %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
PFF_medSoil <- PFF_medSoil %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)

CARE_medPM <- CARE_medPM %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medSO4 <- CARE_medSO4 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medNO3 <- CARE_medNO3 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medNH4 <- CARE_medNH4 %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medBC <- CARE_medBC %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medOM <- CARE_medOM %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medSS <- CARE_medSS %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
CARE_medSoil <- CARE_medSoil %>% dplyr::select(ID, Mean, Median, Q1, Q3, StdDev)
```

```{r}
Simm_medPM <- Simm_medPM %>% mutate(pollutant="PM")
Simm_medSO4 <- Simm_medSO4 %>% mutate(pollutant="SO4")
Simm_medNO3 <- Simm_medNO3 %>% mutate(pollutant="NO3")
Simm_medNH4 <- Simm_medNH4 %>% mutate(pollutant="NH4")
Simm_medBC <- Simm_medBC %>% mutate(pollutant="BC")
Simm_medOM <- Simm_medOM %>% mutate(pollutant="OM")
Simm_medSS <- Simm_medSS %>% mutate(pollutant="SS")
Simm_medSoil <- Simm_medSoil %>% mutate(pollutant="Soil")

PFF_medPM <- PFF_medPM %>% mutate(pollutant="PM")
PFF_medSO4 <- PFF_medSO4 %>% mutate(pollutant="SO4")
PFF_medNO3 <- PFF_medNO3 %>% mutate(pollutant="NO3")
PFF_medNH4 <- PFF_medNH4 %>% mutate(pollutant="NH4")
PFF_medBC <- PFF_medBC %>% mutate(pollutant="BC")
PFF_medOM <- PFF_medOM %>% mutate(pollutant="OM")
PFF_medSS <- PFF_medSS %>% mutate(pollutant="SS")
PFF_medSoil <- PFF_medSoil %>% mutate(pollutant="Soil")

CARE_medPM <- CARE_medPM %>% mutate(pollutant="PM")
CARE_medSO4 <- CARE_medSO4 %>% mutate(pollutant="SO4")
CARE_medNO3 <- CARE_medNO3 %>% mutate(pollutant="NO3")
CARE_medNH4 <- CARE_medNH4 %>% mutate(pollutant="NH4")
CARE_medBC <- CARE_medBC %>% mutate(pollutant="BC")
CARE_medOM <- CARE_medOM %>% mutate(pollutant="OM")
CARE_medSS <- CARE_medSS %>% mutate(pollutant="SS")
CARE_medSoil <- CARE_medSoil %>% mutate(pollutant="Soil")
```

```{r}
Simm_medPM <- Simm_medPM %>% mutate(cohort="Simm")
Simm_medSO4 <- Simm_medSO4 %>% mutate(cohort="Simm")
Simm_medNO3 <- Simm_medNO3 %>% mutate(cohort="Simm")
Simm_medNH4 <- Simm_medNH4 %>% mutate(cohort="Simm")
Simm_medBC <- Simm_medBC %>% mutate(cohort="Simm")
Simm_medOM <- Simm_medOM %>% mutate(cohort="Simm")
Simm_medSS <- Simm_medSS %>% mutate(cohort="Simm")
Simm_medSoil <- Simm_medSoil %>% mutate(cohort="Simm")

PFF_medPM <- PFF_medPM %>% mutate(cohort="PFF")
PFF_medSO4 <- PFF_medSO4 %>% mutate(cohort="PFF")
PFF_medNO3 <- PFF_medNO3 %>% mutate(cohort="PFF")
PFF_medNH4 <- PFF_medNH4 %>% mutate(cohort="PFF")
PFF_medBC <- PFF_medBC %>% mutate(cohort="PFF")
PFF_medOM <- PFF_medOM %>% mutate(cohort="PFF")
PFF_medSS <- PFF_medSS %>% mutate(cohort="PFF")
PFF_medSoil <- PFF_medSoil %>% mutate(cohort="PFF")

CARE_medPM <- CARE_medPM %>% mutate(cohort="CARE")
CARE_medSO4 <- CARE_medSO4 %>% mutate(cohort="CARE")
CARE_medNO3 <- CARE_medNO3 %>% mutate(cohort="CARE")
CARE_medNH4 <- CARE_medNH4 %>% mutate(cohort="CARE")
CARE_medBC <- CARE_medBC %>% mutate(cohort="CARE")
CARE_medOM <- CARE_medOM %>% mutate(cohort="CARE")
CARE_medSS <- CARE_medSS %>% mutate(cohort="CARE")
CARE_medSoil <- CARE_medSoil %>% mutate(cohort="CARE")
```

```{r}
PFF_medPM <- PFF_medPM %>% group_by(ID) %>% slice(1)
PFF_medSO4 <- PFF_medSO4 %>% group_by(ID) %>% slice(1)
PFF_medNO3 <- PFF_medNO3 %>% group_by(ID) %>% slice(1)
PFF_medNH4 <- PFF_medNH4 %>% group_by(ID) %>% slice(1)
PFF_medBC <- PFF_medBC %>% group_by(ID) %>% slice(1)
PFF_medOM <- PFF_medOM %>% group_by(ID) %>% slice(1)
PFF_medSS <- PFF_medSS %>% group_by(ID) %>% slice(1)
PFF_medSoil <- PFF_medSoil %>% group_by(ID) %>% slice(1)

CARE_medPM <- CARE_medPM %>% group_by(ID) %>% slice(1)
CARE_medSO4 <- CARE_medSO4 %>% group_by(ID) %>% slice(1)
CARE_medNO3 <- CARE_medNO3 %>% group_by(ID) %>% slice(1)
CARE_medNH4 <- CARE_medNH4 %>% group_by(ID) %>% slice(1)
CARE_medBC <- CARE_medBC %>% group_by(ID) %>% slice(1)
CARE_medOM <- CARE_medOM %>% group_by(ID) %>% slice(1)
CARE_medSS <- CARE_medSS %>% group_by(ID) %>% slice(1)
CARE_medSoil <- CARE_medSoil %>% group_by(ID) %>% slice(1)
```


```{r}
Simm_summary <- rbind(Simm_medPM, Simm_medSO4, Simm_medNO3, Simm_medNH4, Simm_medBC, Simm_medOM, Simm_medSS, Simm_medSoil)
PFF_summary <- rbind(PFF_medPM, PFF_medSO4, PFF_medNO3, PFF_medNH4, PFF_medBC, PFF_medOM, PFF_medSS, PFF_medSoil)
CARE_summary <- rbind(CARE_medPM, CARE_medSO4, CARE_medNO3, CARE_medNH4, CARE_medBC, CARE_medOM, CARE_medSS, CARE_medSoil)
CombinedCohorts_summary <- rbind(Simm_summary, PFF_summary, CARE_summary)
```

```{r}
write_xlsx(CombinedCohorts_summary, "CombinedCohorts_TimeVaryingSummarizedExposures_2023_03_16.xlsx")
```


## Summarize Demographics Between Low vs High Exposures
### Split Each Cohort into Low vs High PM2.5
```{r}
low_Simm <- Simm_medPM %>% filter(Median<8)
low_Simm <- left_join(low_Simm, Simm, by="ID")
low_Simm <- low_Simm %>% group_by(ID) %>% slice(1)

high_Simm <- Simm_medPM %>% filter(Median>=8)
high_Simm <- left_join(high_Simm, Simm, by="ID")
high_Simm <- high_Simm %>% group_by(ID) %>% slice(1)
```

```{r}
low_PFF <- PFF_medPM %>% filter(Median<8)
low_PFF <- left_join(low_PFF, PFF, by="ID")
low_PFF <- low_PFF %>% group_by(ID) %>% slice(1)

high_PFF <- PFF_medPM %>% filter(Median>=8)
high_PFF <- left_join(high_PFF, PFF, by="ID")
high_PFF <- high_PFF %>% group_by(ID) %>% slice(1)
```

```{r}
low_CARE <- CARE_medPM %>% filter(Median<8)
low_CARE <- left_join(low_CARE, CARE, by="ID")
low_CARE <- low_CARE %>% group_by(ID) %>% slice(1)

high_CARE <- CARE_medPM %>% filter(Median>=8)
high_CARE <- left_join(high_CARE, CARE, by="ID")
high_CARE <- high_CARE %>% group_by(ID) %>% slice(1)
```

### Summarizing Function
```{r}
n_prop_tbl <- function(x) {
  tbl <- table(x)
  res <- cbind(tbl, round(prop.table(tbl)*100,2))
  colnames(res) <-  c('Count', 'Percentage')
  res
}
```

### Sex Breakdown
```{r}
n_prop_tbl(low_Simm$sex)
n_prop_tbl(high_Simm$sex)
```

```{r}
n_prop_tbl(low_PFF$sex.x)
n_prop_tbl(high_PFF$sex.x)
```

```{r}
n_prop_tbl(low_CARE$sex.x)
n_prop_tbl(high_CARE$sex.x)
```

### Race Breakdown
```{r}
n_prop_tbl(low_Simm$dich_Race)
n_prop_tbl(high_Simm$dich_Race)
```

```{r}
n_prop_tbl(low_PFF$dich_Race.x)
n_prop_tbl(high_PFF$dich_Race.x)
```

```{r}
n_prop_tbl(low_CARE$dich_Race.x)
n_prop_tbl(high_CARE$dich_Race.x)
```

### Smoking History Breakdown
```{r}
n_prop_tbl(low_Simm$smokeHx)
n_prop_tbl(high_Simm$smokeHx)
```

```{r}
n_prop_tbl(low_PFF$smokeHx.x)
n_prop_tbl(high_PFF$smokeHx.x)
```

```{r}
n_prop_tbl(low_CARE$smokeHx.x)
n_prop_tbl(high_CARE$smokeHx.x)
```

### Diagnosis Group Breakdown
```{r}
n_prop_tbl(low_Simm$dx_group)
n_prop_tbl(high_Simm$dx_group)
```

```{r}
n_prop_tbl(low_PFF$dx_group.x)
n_prop_tbl(high_PFF$dx_group.x)
```

```{r}
n_prop_tbl(low_CARE$dx_group.x)
n_prop_tbl(high_CARE$dx_group.x)
```

## Age at Enrollment Breakdown
```{r}
summary(low_Simm$age_dx)
summary(high_Simm$age_dx)
```

```{r}
summary(low_PFF$age_dx.x)
summary(high_PFF$age_dx.x)
```

```{r}
summary(low_CARE$age_dx.x)
summary(high_CARE$age_dx.x)
```

## Baseline FVC Breakdown
```{r}
summary(low_Simm$fvc_pct)
summary(high_Simm$fvc_pct)
```

```{r}
summary(low_PFF$fvc_pct.x)
summary(high_PFF$fvc_pct.x)
```

```{r}
summary(low_CARE$fvc_pct.x)
summary(high_CARE$fvc_pct.x)
```

## Baseline DLCO Breakdown
```{r}
summary(low_Simm$dlco_pct)
summary(high_Simm$dlco_pct)
```

```{r}
summary(low_PFF$dlco_pct.x)
summary(high_PFF$dlco_pct.x)
```

```{r}
summary(low_CARE$dlco_pct.x)
summary(high_CARE$dlco_pct.x)
```

## ECDF-Adjusted Disadvantage Score Breakdown
```{r}
summary(low_Simm$disadv)
summary(high_Simm$disadv)
```

```{r}
summary(low_PFF$disadv.x)
summary(high_PFF$disadv.x)
```

```{r}
summary(low_CARE$disadv.x)
summary(high_CARE$disadv.x)
```

## Time to Censoring Breakdown
```{r}
summary(low_Simm$time_DeathTxCensor)
summary(high_Simm$time_DeathTxCensor)
```

```{r}
summary(low_PFF$time_DeathTxCensor.x)
summary(high_PFF$time_DeathTxCensor.x)
```

```{r}
summary(low_CARE$time_DeathTxCensor.x)
summary(high_CARE$time_DeathTxCensor.x)
```

### Survival Status Breakdown
```{r}
n_prop_tbl(low_Simm$status)
n_prop_tbl(high_Simm$status)
```

```{r}
n_prop_tbl(low_PFF$status.x)
n_prop_tbl(high_PFF$status.x)
```

```{r}
n_prop_tbl(low_CARE$status.x)
n_prop_tbl(high_CARE$status.x)
```


# Remove unnecessary dataframes
```{r}
rm(Simm_medPM, Simm_medSO4, Simm_medNO3, Simm_medNH4, Simm_medBC, Simm_medOM, Simm_medSS, Simm_medSoil, PFF_medPM, PFF_medSO4, PFF_medNO3, PFF_medNH4, PFF_medBC, PFF_medOM, PFF_medSS, PFF_medSoil, CARE_medPM, CARE_medSO4, CARE_medNO3, CARE_medNH4, CARE_medBC, CARE_medOM, CARE_medSS, CARE_medSoil)
```

# Combined One-Stage Meta-Analysis with Time-Weighted Exposure Estimates
## PM2.5 
### PM2.5 Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### PM2.5 Per IQR
```{r}
summary(All$PM)
IQR(All$PM, na.rm=T)

# Will use the 5yr pre-censoring IQR (2.592959), not this one
All <- All %>% mutate(PM_IQR = PM/2.592959)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ PM_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 1.26 per IQR increase in PM2.5 as compared with a HR of 1.09 per 1ug/m3 increase in PM2.5.

### PM2.5 Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(PM) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & PM<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$PM, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$PM, exp(predicted$fit), type="n", xlim=c(0,20), ylim=c(0,15))
lines(sm.spline(Allx$PM, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$PM, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$PM, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(PM) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & PM<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$PM, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$PM, exp(predicted$fit), type="n", xlim=c(0,20), ylim=c(0,10))
lines(sm.spline(Allx$PM, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$PM, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$PM, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## SO4 
### SO4 Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### SO4 Per IQR
```{r}
summary(All$SO4)
IQR(All$SO4, na.rm=T)

# Will use the 5yr pre-censoring IQR (0.9653843), not this one
All <- All %>% mutate(SO4_IQR = SO4/0.9653843)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SO4_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 2.05 per IQR increase in SO4 as compared with a HR of 2.11 per 1ug/m3 increase in SO4.

### SO4 Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(SO4) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & SO4<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$SO4, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$SO4, exp(predicted$fit), type="n")
lines(sm.spline(Allx$SO4, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$SO4, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$SO4, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(SO4) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & SO4<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$SO4, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$SO4, exp(predicted$fit), type="n")
lines(sm.spline(Allx$SO4, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$SO4, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$SO4, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## NO3 
### NO3 Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### NO3 Per IQR
```{r}
summary(All$NO3)
IQR(All$NO3, na.rm=T)

# Will use the 5yr pre-censoring IQR (0.5319728), not this one
All <- All %>% mutate(NO3_IQR = NO3/0.5319728)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NO3_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 0.99 per IQR increase in NO3 as compared with a HR of 0.99 per 1ug/m3 increase in NO3.

### NO3 Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(NO3) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & NO3<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$NO3, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r, eval=F}
#Then plot
plot(Allx$NO3, exp(predicted$fit), type="n")
lines(sm.spline(Allx$NO3, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$NO3, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$NO3, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(NO3) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & NO3<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$NO3, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$NO3, exp(predicted$fit), type="n")
lines(sm.spline(Allx$NO3, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$NO3, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$NO3, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## NH4 
### NH4 Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### NH4 Per IQR
```{r}
summary(All$NH4)
IQR(All$NH4, na.rm=T)

# Will use the 5yr pre-censoring IQR (0.3400484), not this one
All <- All %>% mutate(NH4_IQR = NH4/0.3400484)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NH4_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 1.78 per IQR increase in NH4 as compared with a HR of 5.41 per 1ug/m3 increase in NH4.

### NH4 Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(NH4) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & NH4>0.005 & NH4<2.55)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$NH4, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$NH4, exp(predicted$fit), type="n")
lines(sm.spline(Allx$NH4, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$NH4, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$NH4, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(NH4) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & NH4>0.005 & NH4<2.55)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$NH4, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$NH4, exp(predicted$fit), type="n")
lines(sm.spline(Allx$NH4, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$NH4, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$NH4, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## BC 
### BC Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### BC Per IQR
```{r}
summary(All$BC)
IQR(All$BC, na.rm=T)

# Will use the 5yr pre-censoring IQR (0.325731), not this one
All <- All %>% mutate(BC_IQR = BC/0.325731)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ BC_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 1.24 per IQR increase in BC as compared with a HR of 1.96 per 1ug/m3 increase in BC.

### BC Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(BC) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & BC<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$BC, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$BC, exp(predicted$fit), type="n")
lines(sm.spline(Allx$BC, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$BC, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$BC, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(BC) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & BC<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$BC, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$BC, exp(predicted$fit), type="n")
lines(sm.spline(Allx$BC, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$BC, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$BC, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## OM 
### OM Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### OM Per IQR
```{r}
summary(All$OM)
IQR(All$OM, na.rm=T)

# Will use the 5yr pre-censoring IQR (1.270977), not this one
All <- All %>% mutate(OM_IQR = OM/1.270977)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ OM_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 0.98 per IQR increase in OM as compared with a HR of 0.98 per 1ug/m3 increase in OM.

### OM Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(OM) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & OM<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$OM, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r, eval=F}
#Then plot
plot(Allx$OM, exp(predicted$fit), type="n")
lines(sm.spline(Allx$OM, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$OM, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$OM, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(OM) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & OM<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$OM, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$OM, exp(predicted$fit), type="n")
lines(sm.spline(Allx$OM, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$OM, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$OM, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## SS 
### SS Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### SS Per IQR
```{r}
summary(All$SS)
IQR(All$SS, na.rm=T)

# Will use the 5yr pre-censoring IQR (0.135), not this one
All <- All %>% mutate(SS_IQR = SS/0.135)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SS_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 1.00 per IQR increase in SS as compared with a HR of 1.00 per 1ug/m3 increase in SS.

### SS Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(SS) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & SS>0)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$SS, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$SS, exp(predicted$fit), type="n")
lines(sm.spline(Allx$SS, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$SS, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$SS, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(SS) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & SS>0.01 & SS<2.5)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$SS, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r, eval=F}
#Then plot
plot(Allx$SS, exp(predicted$fit), type="n")
lines(sm.spline(Allx$SS, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$SS, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$SS, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



## Soil 
### Soil Continuous Models
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```

### Soil Per IQR
```{r}
summary(All$Soil)
IQR(All$Soil, na.rm=T)

# Will use the 5yr pre-censoring IQR (0.2614493), not this one
All <- All %>% mutate(Soil_IQR = Soil/0.2614493)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ Soil_IQR + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All, id=ID)
summary(coxPH_model2)
```
So this indicates that there is a HR of 1.05 per IQR increase in Soil as compared with a HR of 1.21 per 1ug/m3 increase in Soil.

### Soil Variable HR Spline Models
Base model
```{r}
#First need to make dataframe that only includes patients with a value for event
Allx <- All %>% filter(!is.na(Soil) & !is.na(deadORtx) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(cohort) & !is.na(site) & Soil<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$Soil, df=3) + Allx$dx_yr + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r}
#Then plot
plot(Allx$Soil, exp(predicted$fit), type="n")
lines(sm.spline(Allx$Soil, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$Soil, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$Soil, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```

Complete model
```{r}
#First need to make dataframe that only includes patients with time_DeathTxCensor
Allx <- All %>% filter(!is.na(Soil) & !is.na(time_DeathTxCensor) & !is.na(dx_yr) & !is.na(deadORtx) & !is.na(age_dx) & !is.na(sex) & !is.na(smokeHx) & !is.na(dich_Race) & !is.na(disadv) & !is.na(site) & Soil<20)

#Then make survival function
surv1 <- Surv(Allx$start, Allx$end, Allx$event==1)
fit1 <- coxph(surv1 ~ pspline(Allx$Soil, df=3) + Allx$dx_yr + Allx$age_dx + Allx$sex + Allx$smokeHx + Allx$dich_Race + Allx$disadv + cluster(Allx$cohort) + Allx$site)
predicted <- predict(fit1, type="terms", se.fit=T, terms=1)
```

```{r, eval=F}
#Then plot
plot(Allx$Soil, exp(predicted$fit), type="n")
lines(sm.spline(Allx$Soil, exp(predicted$fit)), col = "red" , lty = 1 )
lines(sm.spline(Allx$Soil, exp(predicted$fit + 1.96 * predicted$se)), col = "orange" , lty = 2 )
lines(sm.spline(Allx$Soil, exp(predicted$fit - 1.96 * predicted$se)), col = "orange" , lty = 2 )
```



# Quantile-Based G-Computation Multi-Pollutant Survival Analysis - No Bootstrapping
## Simmons Alone
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr, data=Simm)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=Simm[,c(Xnm, 'start', 'end', 'event', 'dx_yr')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```
So the HR of the overall model is 1.22 (95% CI 1.06-1.40) and that is primarily driven by NH4, SS, OM, and BC

Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr, data=Simm)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=Simm[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```
So the HR of the overall model is 1.19 (95% CI 1.03-1.38) and that is primarily driven by NH4, OM, SS, and BC

Now to plot the findings
```{r}
plot(qc.survfit2)
```


## PFF Alone
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr + site, data=PFF)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=PFF[,c(Xnm, 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```
So the HR of the overall model is 0.90 (95% CI 0.78-1.03) and the positive direction of effect (i.e. harmful) primarily driven by BC, OM, and SS

Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr + site, data=PFF)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=PFF[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```
So the HR of the overall model is 0.90 (95% CI 0.79-1.03) and the positive direction of effect (i.e. harmful) primarily driven by BC, OM, and SS

Now to plot the findings
```{r}
plot(qc.survfit2)
```




## CARE Alone
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr + site, data=CARE)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=CARE[,c(Xnm, 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```
So the HR of the overall model is 0.76 (95% CI 0.70-0.83) with the positive direction of effects (i.e. harmful) primarily driven by Soil, NO3, and BC

Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr + site, data=CARE)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=CARE[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```
So the HR of the overall model is 0.76 (95% CI 0.70-0.84) with the positive direction of effects (i.e. harmful) primarily driven by Soil, NO3, and BC

Now to plot the findings
```{r}
plot(qc.survfit2)
```



## One-Stage Meta-Analysis - i.e. Combined Cohorts
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr + site + cluster(cohort), data=All)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=All[,c(Xnm, 'start', 'end', 'event', 'dx_yr', 'site', 'cohort')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```
So the HR of the overall model is 1.02 (95% CI 0.95-1.09) with the positive direction of effects (i.e. harmful) primarily driven by BC, Soil, SO4

Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr + site + cluster(cohort), data=All)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=All[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr', 'site', 'cohort')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```
So the HR of the overall model is 1.02 (95% CI 0.95-1.10) with the positive direction of effects (i.e. harmful) primarily driven by BC, SO4, and Soil

Now to plot the findings
```{r}
plot(qc.survfit2)
```


# Creating IPF-specific Dataframes
## IPF-Only Simmons
```{r}
Simm_IPF <- Simm %>% filter(dx=="IPF")
```

## IPF-Only PFF
```{r}
PFF_IPF <- PFF %>% filter(dx=="IPF")
```

## IPF-Only CARE-PF
```{r}
CARE_IPF <- CARE %>% filter(dx=="IPF")
```

## IPF-Only Combined Cohorts
```{r}
All_IPF <- All %>% filter(dx=="IPF")
```

# IPF-Alone Subgroup Analysis with Time-Weighted Exposure Estimates
## IPF-Only PM2.5 
### IPF-Only PM2.5 - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only PM2.5 - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only PM2.5 - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only PM2.5 - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ PM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```

## IPF-Only SO4 
### IPF-Only SO4 - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only SO4 - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only SO4 - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only SO4 - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SO4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```

## IPF-Only NO3 
### IPF-Only NO3 - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only NO3 - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only NO3 - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only NO3 - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NO3 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```


## IPF-Only NH4 
### IPF-Only NH4 - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only NH4 - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only NH4 - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only NH4 - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ NH4 + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```

## IPF-Only BC 
### IPF-Only BC - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only BC - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only BC - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only BC - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ BC + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```


## IPF-Only OM 
### IPF-Only OM - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only OM - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only OM - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only OM - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ OM + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```


## IPF-Only SS 
### IPF-Only SS - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only SS - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only SS - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only SS - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ SS + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```


## IPF-Only Soil 
### IPF-Only Soil - Simmons Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr, data=Simm_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv, data=Simm_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only Soil - PFF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + site, data=PFF_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=PFF_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only Soil - CARE-PF Cohort
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + site, data=CARE_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site, data=CARE_IPF, id=ID)
summary(coxPH_model2)
```

### IPF-Only Soil - Combined Cohorts
```{r}
coxPH_model1 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model1)
```

```{r}
coxPH_model2 <- coxph(Surv(start, end, event==1) ~ Soil + dx_yr + age_dx + sex + dich_Race + smokeHx + disadv + site + cluster(cohort), data=All_IPF, id=ID)
summary(coxPH_model2)
```


# IPF-Only Quantile-Based G-Computation Multi-Pollutant Survival Analysis - No Bootstrapping
## IPF-Only Simmons Alone
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr, data=Simm_IPF)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=Simm_IPF[,c(Xnm, 'start', 'end', 'event', 'dx_yr')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr, data=Simm_IPF)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=Simm_IPF[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit2)
```


## IPF-Only PFF Alone
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr + site, data=PFF_IPF)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=PFF_IPF[,c(Xnm, 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr + site, data=PFF_IPF)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=PFF_IPF[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit2)
```




## IPF-Only CARE Alone
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr + site, data=CARE_IPF)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=CARE_IPF[,c(Xnm, 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model + dx_yr
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr + site, data=CARE_IPF)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=CARE_IPF[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr', 'site')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit2)
```



## IPF-Only One-Stage Meta-Analysis - i.e. Combined Cohorts
Multi-pollutant model without other covariates aside from dx_yr and site
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + dx_yr + site + cluster(cohort), data=All_IPF)

#Next the quantile regression model
qc.survfit1 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=All_IPF[,c(Xnm, 'start', 'end', 'event', 'dx_yr', 'site', 'cohort')], q=4)
qc.survfit1

#Lastly the HR is reported through the following
exp(qc.survfit1$coef)
exp(qc.survfit1$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit1)
```


Complete multi-pollutant model
```{r}
#First need to list the pollutants in the model
Xnm <- c('SO4','NO3','NH4','BC','OM','SS','Soil')

#Next construct the base cox model
survival::coxph(survival::Surv(start, end, event==1) ~ SO4 + NH4 + NO3 + BC + OM + SS + Soil + age_dx + sex + smokeHx + dich_Race + disadv + dx_yr + site + cluster(cohort), data=All_IPF)

#Next the quantile regression model
qc.survfit2 <- qgcomp.cox.noboot(survival::Surv(start, end, event==1) ~ ., expnms=Xnm, data=All_IPF[,c(Xnm, 'age_dx', 'sex', 'smokeHx', 'dich_Race', 'disadv', 'start', 'end', 'event', 'dx_yr', 'site', 'cohort')], q=4)
qc.survfit2

#Lastly the HR is reported through the following
exp(qc.survfit2$coef)
exp(qc.survfit2$ci)
```


Now to plot the findings
```{r}
plot(qc.survfit2)
```






